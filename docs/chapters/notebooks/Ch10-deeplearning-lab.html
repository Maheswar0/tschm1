

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Chapter 10 &#8212; Introduction to Statistical Learning</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/chapters/notebooks/Ch10-deeplearning-lab';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Chapter 11" href="Ch11-surv-lab.html" />
    <link rel="prev" title="Introduction to Statistical Learning" href="../index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo.jpeg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/logo.jpeg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Introduction to Statistical Learning
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../index.html">Introduction to Statistical Learning</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Chapter 10</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch11-surv-lab.html">Chapter 11</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch12-unsup-lab.html">Chapter 12</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch13-multiple-lab.html">Chapter 13</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch2-statlearn-lab.html">Chapter 2</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch3-linreg-lab.html">Chapter 3</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch5-resample-lab.html">Chapter 5</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch6-varselect-lab.html">Chapter 6</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch7-nonlin-lab.html">Chapter 7</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch8-baggboost-lab.html">Chapter 8</a></li>

<li class="toctree-l2"><a class="reference internal" href="Ch9-svm-lab.html">Chapter 9</a></li>

</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/tschm/isl/master?urlpath=tree/book/docs/chapters/notebooks/Ch10-deeplearning-lab.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/tschm/isl" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/tschm/isl/edit/master/book/docs/chapters/notebooks/Ch10-deeplearning-lab.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/tschm/isl/issues/new?title=Issue%20on%20page%20%2Fdocs/chapters/notebooks/Ch10-deeplearning-lab.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/docs/chapters/notebooks/Ch10-deeplearning-lab.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Chapter 10</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Chapter 10</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#lab-deep-learning">Lab: Deep Learning</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#torch-specific-imports">Torch-Specific Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#single-layer-network-on-hitters-data">Single Layer Network on Hitters Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-models">Linear Models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specifying-a-network-classes-and-inheritance">Specifying a Network: Classes and Inheritance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleanup">Cleanup</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multilayer-network-on-the-mnist-digit-data">Multilayer Network on the MNIST Digit Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convolutional-neural-networks">Convolutional Neural Networks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-acceleration">Hardware Acceleration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-pretrained-cnn-models">Using Pretrained CNN Models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imdb-document-classification">IMDB Document Classification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-to-lasso">Comparison to Lasso</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recurrent-neural-networks">Recurrent Neural Networks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-models-for-document-classification">Sequential Models for Document Classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-prediction">Time Series Prediction</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="chapter-10">
<h1>Chapter 10<a class="headerlink" href="#chapter-10" title="Permalink to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="lab-deep-learning">
<h1>Lab: Deep Learning<a class="headerlink" href="#lab-deep-learning" title="Permalink to this heading">#</a></h1>
<p>In this section we  demonstrate how to fit the examples discussed
in the text. We use the <code class="docutils literal notranslate"><span class="pre">Python</span></code>  <code class="docutils literal notranslate"><span class="pre">torch</span></code> package, along with the
<code class="docutils literal notranslate"><span class="pre">pytorch_lightning</span></code> package which provides utilities to simplify
fitting and evaluating models.  This code can be impressively fast
with certain  special processors,  such as Apple’s new M1 chip. The package is well-structured, flexible, and will feel comfortable
to <code class="docutils literal notranslate"><span class="pre">Python</span></code>  users. A good companion is the site
<a class="reference external" href="https://pytorch.org/tutorials/beginner/basics/intro.html">pytorch.org/tutorials</a>.
Much of our code is adapted from there, as well as the <code class="docutils literal notranslate"><span class="pre">pytorch_lightning</span></code> documentation. {The precise URLs at the time of writing are <a class="reference external" href="https://pytorch.org/tutorials/beginner/basics/intro.html">https://pytorch.org/tutorials/beginner/basics/intro.html</a> and <a class="reference external" href="https://pytorch-lightning.readthedocs.io/en/latest/">https://pytorch-lightning.readthedocs.io/en/latest/</a>.}</p>
<p>We start with several standard imports that we have  seen in other contexts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">subplots</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> \
     <span class="p">(</span><span class="n">LinearRegression</span><span class="p">,</span>
      <span class="n">LogisticRegression</span><span class="p">,</span>
      <span class="n">Lasso</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">ISLP</span> <span class="kn">import</span> <span class="n">load_data</span>
<span class="kn">from</span> <span class="nn">ISLP.models</span> <span class="kn">import</span> <span class="n">ModelSpec</span> <span class="k">as</span> <span class="n">MS</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> \
     <span class="p">(</span><span class="n">train_test_split</span><span class="p">,</span>
      <span class="n">GridSearchCV</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="torch-specific-imports">
<h2>Torch-Specific Imports<a class="headerlink" href="#torch-specific-imports" title="Permalink to this heading">#</a></h2>
<p>There are a number of imports for <code class="docutils literal notranslate"><span class="pre">torch</span></code>. (These are not
included with <code class="docutils literal notranslate"><span class="pre">ISLP</span></code>, so must be installed separately.)
First we import the main library
and essential tools used to specify sequentially-structured networks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">RMSprop</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span>
</pre></div>
</div>
</div>
</div>
<p>There are several other helper packages for <code class="docutils literal notranslate"><span class="pre">torch</span></code>. For instance,
the <code class="docutils literal notranslate"><span class="pre">torchmetrics</span></code> package has utilities to compute
various metrics to evaluate performance when fitting
a model. The <code class="docutils literal notranslate"><span class="pre">torchinfo</span></code> package provides a useful
summary of the layers of a model. We use the <code class="docutils literal notranslate"><span class="pre">read_image()</span></code>
function when loading test images in Section 10.9.4.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchmetrics</span> <span class="kn">import</span> <span class="p">(</span><span class="n">MeanAbsoluteError</span><span class="p">,</span>
                          <span class="n">R2Score</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">torchinfo</span> <span class="kn">import</span> <span class="n">summary</span>
<span class="kn">from</span> <span class="nn">torchvision.io</span> <span class="kn">import</span> <span class="n">read_image</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">torchmetrics</span> <span class="kn">import</span> <span class="p">(</span><span class="n">MeanAbsoluteError</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                           <span class="n">R2Score</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">torchinfo</span> <span class="kn">import</span> <span class="n">summary</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">torchvision.io</span> <span class="kn">import</span> <span class="n">read_image</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torchmetrics&#39;
</pre></div>
</div>
</div>
</div>
<p>The package <code class="docutils literal notranslate"><span class="pre">pytorch_lightning</span></code> is a somewhat higher-level
interface to <code class="docutils literal notranslate"><span class="pre">torch</span></code> that simplifies the specification and
fitting of
models by reducing the amount of boilerplate code needed
(compared to using <code class="docutils literal notranslate"><span class="pre">torch</span></code> alone).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytorch_lightning</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.loggers</span> <span class="kn">import</span> <span class="n">CSVLogger</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">pytorch_lightning</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">from</span> <span class="nn">pytorch_lightning.loggers</span> <span class="kn">import</span> <span class="n">CSVLogger</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;pytorch_lightning&#39;
</pre></div>
</div>
</div>
</div>
<p>In order to reproduce results we use <code class="docutils literal notranslate"><span class="pre">seed_everything()</span></code>. We will also instruct <code class="docutils literal notranslate"><span class="pre">torch</span></code> to use deterministic algorithms
where possible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytorch_lightning.utilities.seed</span> <span class="kn">import</span> <span class="n">seed_everything</span>
<span class="n">seed_everything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">pytorch_lightning.utilities.seed</span> <span class="kn">import</span> <span class="n">seed_everything</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">seed_everything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;pytorch_lightning&#39;
</pre></div>
</div>
</div>
</div>
<p>We will use several datasets shipped with <code class="docutils literal notranslate"><span class="pre">torchvision</span></code> for our
examples: a pretrained network for image classification,
as well as some transforms used for preprocessing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="kn">import</span> <span class="n">MNIST</span><span class="p">,</span> <span class="n">CIFAR100</span>
<span class="kn">from</span> <span class="nn">torchvision.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">resnet50</span><span class="p">,</span>
                                <span class="n">ResNet50_Weights</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Resize</span><span class="p">,</span>
                                    <span class="n">Normalize</span><span class="p">,</span>
                                    <span class="n">CenterCrop</span><span class="p">,</span>
                                    <span class="n">ToTensor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="kn">import</span> <span class="n">MNIST</span><span class="p">,</span> <span class="n">CIFAR100</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">from</span> <span class="nn">torchvision.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">resnet50</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                                 <span class="n">ResNet50_Weights</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Resize</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                                     <span class="n">Normalize</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                                     <span class="n">CenterCrop</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                                     <span class="n">ToTensor</span><span class="p">)</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torchvision&#39;
</pre></div>
</div>
</div>
</div>
<p>We have provided a few utilities in <code class="docutils literal notranslate"><span class="pre">ISLP</span></code> specifically for this lab.
The <code class="docutils literal notranslate"><span class="pre">SimpleDataModule</span></code> and <code class="docutils literal notranslate"><span class="pre">SimpleModule</span></code> are simple
versions of objects used in <code class="docutils literal notranslate"><span class="pre">pytorch_lightning</span></code>, the
high-level module for fitting <code class="docutils literal notranslate"><span class="pre">torch</span></code> models. Although more advanced
uses such as computing on graphical processing units (GPUs) and parallel data processing
are possible in this module, we will not be focusing much on these
in this lab. The <code class="docutils literal notranslate"><span class="pre">ErrorTracker</span></code> handles
collections of targets and predictions over each mini-batch
in the validation or test stage, allowing computation
of the metric over the entire validation or test data set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ISLP.torch</span> <span class="kn">import</span> <span class="p">(</span><span class="n">SimpleDataModule</span><span class="p">,</span>
                        <span class="n">SimpleModule</span><span class="p">,</span>
                        <span class="n">ErrorTracker</span><span class="p">,</span>
                        <span class="n">rec_num_workers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">ISLP.torch</span> <span class="kn">import</span> <span class="p">(</span><span class="n">SimpleDataModule</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                         <span class="n">SimpleModule</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                         <span class="n">ErrorTracker</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                         <span class="n">rec_num_workers</span><span class="p">)</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">isl</span><span class="o">/</span><span class="n">isl</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.10</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ISLP</span><span class="o">/</span><span class="n">torch</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">.lightning</span> <span class="kn">import</span> <span class="p">(</span><span class="n">SimpleDataModule</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                         <span class="n">SimpleModule</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                         <span class="n">ErrorTracker</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">def</span> <span class="nf">rec_num_workers</span><span class="p">():</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">11</span><span class="sd">     Get a suggested number of workers for data loaders</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span><span class="sd">     https://github.com/pytorch/pytorch/blob/fb0f285638338da93960d2b654a59c9639671fc0/torch/utils/data/dataloader.py#L478-L505</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span><span class="sd">     &quot;&quot;&quot;</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">isl</span><span class="o">/</span><span class="n">isl</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.10</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ISLP</span><span class="o">/</span><span class="n">torch</span><span class="o">/</span><span class="n">lightning</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="p">(</span><span class="n">random_split</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                               <span class="n">DataLoader</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>                               <span class="n">Dataset</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">concat</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="kn">from</span> <span class="nn">torchmetrics</span> <span class="kn">import</span> <span class="n">Accuracy</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torchvision&#39;
</pre></div>
</div>
</div>
</div>
<p>In addition we have included some helper
functions to load the
<code class="docutils literal notranslate"><span class="pre">IMDb</span></code> database, as well as a lookup that maps integers
to particular keys in the database. We’ve included
a slightly modified copy of the preprocessed
<code class="docutils literal notranslate"><span class="pre">IMDb</span></code> data from <code class="docutils literal notranslate"><span class="pre">keras</span></code>, a separate package
for fitting deep learning models. This saves us significant
preprocessing and allows us to focus on specifying and fitting
the models themselves.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ISLP.torch.imdb</span> <span class="kn">import</span> <span class="p">(</span><span class="n">load_lookup</span><span class="p">,</span>
                             <span class="n">load_tensor</span><span class="p">,</span>
                             <span class="n">load_sparse</span><span class="p">,</span>
                             <span class="n">load_sequential</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">ISLP.torch.imdb</span> <span class="kn">import</span> <span class="p">(</span><span class="n">load_lookup</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                              <span class="n">load_tensor</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                              <span class="n">load_sparse</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                              <span class="n">load_sequential</span><span class="p">)</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">isl</span><span class="o">/</span><span class="n">isl</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.10</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ISLP</span><span class="o">/</span><span class="n">torch</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">.lightning</span> <span class="kn">import</span> <span class="p">(</span><span class="n">SimpleDataModule</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                         <span class="n">SimpleModule</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                         <span class="n">ErrorTracker</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">def</span> <span class="nf">rec_num_workers</span><span class="p">():</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span><span class="sd"> </span>
<span class="g g-Whitespace">     </span><span class="mi">11</span><span class="sd">     Get a suggested number of workers for data loaders</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span><span class="sd">     https://github.com/pytorch/pytorch/blob/fb0f285638338da93960d2b654a59c9639671fc0/torch/utils/data/dataloader.py#L478-L505</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span><span class="sd">     &quot;&quot;&quot;</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">isl</span><span class="o">/</span><span class="n">isl</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.10</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ISLP</span><span class="o">/</span><span class="n">torch</span><span class="o">/</span><span class="n">lightning</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="p">(</span><span class="n">random_split</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                               <span class="n">DataLoader</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>                               <span class="n">Dataset</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">concat</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">TensorDataset</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="kn">from</span> <span class="nn">torchmetrics</span> <span class="kn">import</span> <span class="n">Accuracy</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;torchvision&#39;
</pre></div>
</div>
</div>
</div>
<p>Finally, we introduce some utility imports  not directly related to
<code class="docutils literal notranslate"><span class="pre">torch</span></code>.
The <code class="docutils literal notranslate"><span class="pre">glob()</span></code> function from the <code class="docutils literal notranslate"><span class="pre">glob</span></code> module is used
to find all files matching wildcard characters, which we will use
in our example applying the <code class="docutils literal notranslate"><span class="pre">ResNet50</span></code> model
to some of our own images.
The <code class="docutils literal notranslate"><span class="pre">json</span></code> module will be used to load
a JSON file for looking up classes to identify the labels of the
pictures in the <code class="docutils literal notranslate"><span class="pre">ResNet50</span></code> example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="single-layer-network-on-hitters-data">
<h2>Single Layer Network on Hitters Data<a class="headerlink" href="#single-layer-network-on-hitters-data" title="Permalink to this heading">#</a></h2>
<p>We start by fitting the models in Section 10.6 on the <code class="docutils literal notranslate"><span class="pre">Hitters</span></code> data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Hitters</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;Hitters&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">Hitters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We will fit two linear models (least squares  and lasso) and  compare their performance
to that of a neural network. For this comparison we will use mean absolute error on a validation dataset.</p>
<div class="amsmath math notranslate nohighlight">
\[\begin{equation*}
\begin{split}
\mbox{MAE}(y,\hat{y}) = \frac{1}{n} \sum_{i=1}^n |y_i-\hat{y}_i|.
\end{split}
\end{equation*}\]</div>
<p>We set up the model matrix and the response.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">Hitters</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Salary&#39;</span><span class="p">),</span> <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">Hitters</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">Hitters</span><span class="p">[</span><span class="s1">&#39;Salary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">to_numpy()</span></code>  method above converts <code class="docutils literal notranslate"><span class="pre">pandas</span></code>
data frames or series to <code class="docutils literal notranslate"><span class="pre">numpy</span></code> arrays.
We do this because we will need to  use <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> to fit the lasso model,
and it requires this conversion.
We also use  a linear regression method from <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>, rather than the method
in Chapter~3 from <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>, to facilitate the comparisons.</p>
<p>We now split the data into test and training, fixing the random
state used by <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> to do the split.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> 
 <span class="n">X_test</span><span class="p">,</span>
 <span class="n">Y_train</span><span class="p">,</span>
 <span class="n">Y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
                            <span class="n">Y</span><span class="p">,</span>
                            <span class="n">test_size</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="linear-models">
<h3>Linear Models<a class="headerlink" href="#linear-models" title="Permalink to this heading">#</a></h3>
<p>We fit the linear model and evaluate the test error directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_lm</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="n">Yhat_test</span> <span class="o">=</span> <span class="n">hit_lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Yhat_test</span> <span class="o">-</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>259.7152883314627
</pre></div>
</div>
</div>
</div>
<p>Next we fit the lasso using <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>. We are using
mean absolute error to select and evaluate a model, rather than mean squared error.
The specialized solver we used in Section 6.5.2 uses only mean squared error. So here, with a bit more work,  we create a cross-validation grid and perform the cross-validation directly.</p>
<p>We encode a pipeline with two steps: we first normalize the features using a <code class="docutils literal notranslate"><span class="pre">StandardScaler()</span></code> transform,
and then fit the lasso without further normalization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span><span class="n">with_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">Lasso</span><span class="p">(</span><span class="n">warm_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">30000</span><span class="p">)</span>
<span class="n">standard_lasso</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s1">&#39;lasso&#39;</span><span class="p">,</span> <span class="n">lasso</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<p>We need to create a grid of values for <span class="math notranslate nohighlight">\(\lambda\)</span>. As is common practice,
we choose a grid of 100 values of <span class="math notranslate nohighlight">\(\lambda\)</span>, uniform on the log scale from <code class="docutils literal notranslate"><span class="pre">lam_max</span></code> down to  <code class="docutils literal notranslate"><span class="pre">0.01*lam_max</span></code>. Here  <code class="docutils literal notranslate"><span class="pre">lam_max</span></code> is the smallest value of
<span class="math notranslate nohighlight">\(\lambda\)</span> with an  all-zero solution. This value equals the largest absolute inner-product between any predictor and the (centered) response. {The derivation of this result is beyond the scope of this book.}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">X_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lam_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">X_s</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">n</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="mi">100</span><span class="p">))</span>
             <span class="o">*</span> <span class="n">lam_max</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we had to transform the data first, since the scale of the variables impacts the choice of <span class="math notranslate nohighlight">\(\lambda\)</span>.
We now perform cross-validation using this sequence of <span class="math notranslate nohighlight">\(\lambda\)</span> values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cv</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>
           <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">lasso</span><span class="p">,</span>
                    <span class="n">param_grid</span><span class="p">,</span>
                    <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
                    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_absolute_error&#39;</span><span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>We extract the lasso model with best cross-validated mean absolute error, and evaluate its
performance on <code class="docutils literal notranslate"><span class="pre">X_test</span></code> and <code class="docutils literal notranslate"><span class="pre">Y_test</span></code>, which were not used in
cross-validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trained_lasso</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">Yhat_test</span> <span class="o">=</span> <span class="n">trained_lasso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">Yhat_test</span> <span class="o">-</span> <span class="n">Y_test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>257.23820107995016
</pre></div>
</div>
</div>
</div>
<p>This is similar to the results we got for the linear model fit by least squares. However, these results can vary a lot for different train/test splits; we encourage the reader to try a different seed in code block 12 and rerun the subsequent code up to this point.</p>
</section>
<section id="specifying-a-network-classes-and-inheritance">
<h3>Specifying a Network: Classes and Inheritance<a class="headerlink" href="#specifying-a-network-classes-and-inheritance" title="Permalink to this heading">#</a></h3>
<p>To fit the neural network, we first set up a model structure
that describes the network.
Doing so requires us to define new classes specific to the model we wish to fit.
Typically this is done in  <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> by sub-classing a generic
representation of a network, which is the approach we take here.
Although this example is simple, we will go through the steps in some detail, since it will serve us well
for the more complex examples to follow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HittersModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HittersModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequential</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.4</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">class</span></code> statement identifies the code chunk as a
declaration for a class <code class="docutils literal notranslate"><span class="pre">HittersModel</span></code>
that inherits from the  base class <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>. This base
class is ubiquitous in <code class="docutils literal notranslate"><span class="pre">torch</span></code> and represents the
mappings in the neural networks.</p>
<p>Indented beneath the <code class="docutils literal notranslate"><span class="pre">class</span></code> statement are the methods of this class:
in this case <code class="docutils literal notranslate"><span class="pre">__init__</span></code> and <code class="docutils literal notranslate"><span class="pre">forward</span></code>.  The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method is
called when an instance of the class is created as in the cell
below. In the methods, <code class="docutils literal notranslate"><span class="pre">self</span></code> always refers to an instance of the
class. In the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method, we have attached two objects to
<code class="docutils literal notranslate"><span class="pre">self</span></code> as attributes: <code class="docutils literal notranslate"><span class="pre">flatten</span></code> and <code class="docutils literal notranslate"><span class="pre">sequential</span></code>. These are used in
the <code class="docutils literal notranslate"><span class="pre">forward</span></code> method to describe the map that this module implements.</p>
<p>There is one additional line in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method, which
is a call to
<code class="docutils literal notranslate"><span class="pre">super()</span></code>. This function allows subclasses (i.e. <code class="docutils literal notranslate"><span class="pre">HittersModel</span></code>)
to access methods of the class they inherit from. For example,
the class <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> has its own <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method, which is different from
the <code class="docutils literal notranslate"><span class="pre">HittersModel.__init__()</span></code> method we’ve written above.
Using <code class="docutils literal notranslate"><span class="pre">super()</span></code> allows us to call the method of the base class. For
<code class="docutils literal notranslate"><span class="pre">torch</span></code> models, we will always be making this <code class="docutils literal notranslate"><span class="pre">super()</span></code> call as it is necessary
for the model to be properly interpreted by <code class="docutils literal notranslate"><span class="pre">torch</span></code>.</p>
<p>The object <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> has more methods than simply <code class="docutils literal notranslate"><span class="pre">__init__</span></code> and <code class="docutils literal notranslate"><span class="pre">forward</span></code>. These
methods are directly accessible to <code class="docutils literal notranslate"><span class="pre">HittersModel</span></code> instances because of this inheritance.
One such method we will see shortly is the <code class="docutils literal notranslate"><span class="pre">eval()</span></code> method, used
to disable dropout for when we want to evaluate the model on test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_model</span> <span class="o">=</span> <span class="n">HittersModel</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The object <code class="docutils literal notranslate"><span class="pre">self.sequential</span></code> is a composition of four maps. The
first maps the 19 features of <code class="docutils literal notranslate"><span class="pre">Hitters</span></code> to 50 dimensions, introducing <span class="math notranslate nohighlight">\(50\times 19+50\)</span> parameters
for the weights and <em>intercept</em>  of the map (often called the <em>bias</em>). This layer
is then mapped to a ReLU layer followed by a 40% dropout layer, and finally a
linear map down to 1 dimension, again with a bias. The total number of
trainable parameters is therefore <span class="math notranslate nohighlight">\(50\times 19+50+50+1=1051\)</span>.</p>
<p>The package <code class="docutils literal notranslate"><span class="pre">torchinfo</span></code> provides a <code class="docutils literal notranslate"><span class="pre">summary()</span></code> function that neatly summarizes
this information. We specify the size of the input and see the size
of each tensor as it passes through layers of the network.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary</span><span class="p">(</span><span class="n">hit_model</span><span class="p">,</span> 
        <span class="n">input_size</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">summary</span><span class="p">(</span><span class="n">hit_model</span><span class="p">,</span> 
<span class="g g-Whitespace">      </span><span class="mi">2</span>         <span class="n">input_size</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                    <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                    <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;summary&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We have truncated the end of the output slightly, here and in subsequent uses.</p>
<p>We now need to transform our training data into a form accessible to <code class="docutils literal notranslate"><span class="pre">torch</span></code>.
The basic
datatype in <code class="docutils literal notranslate"><span class="pre">torch</span></code> is a <code class="docutils literal notranslate"><span class="pre">tensor</span></code>, which is very similar
to an <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> from early chapters.
We also note here that <code class="docutils literal notranslate"><span class="pre">torch</span></code> typically
works with 32-bit (<em>single precision</em>)
rather than 64-bit (<em>double precision</em>) floating point numbers.
We therefore convert our data to <code class="docutils literal notranslate"><span class="pre">np.float32</span></code> before
forming the tensor.
The <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> tensors are then arranged into a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>
recognized by <code class="docutils literal notranslate"><span class="pre">torch</span></code>
using <code class="docutils literal notranslate"><span class="pre">TensorDataset()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">Y_train_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">hit_train</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">X_train_t</span><span class="p">,</span> <span class="n">Y_train_t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We do the same for the test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">Y_test_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Y_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">hit_test</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">X_test_t</span><span class="p">,</span> <span class="n">Y_test_t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, this dataset is passed to a <code class="docutils literal notranslate"><span class="pre">DataLoader()</span></code> which ultimately
passes data into our network. While this may seem
like a lot of overhead, this structure is helpful for more
complex tasks where data may live on different machines,
or where data must be passed to a GPU.
We provide a helper function <code class="docutils literal notranslate"><span class="pre">SimpleDataModule()</span></code> in <code class="docutils literal notranslate"><span class="pre">ISLP</span></code> to make this task easier for
standard usage.
One of its arguments is <code class="docutils literal notranslate"><span class="pre">num_workers</span></code>, which indicates
how many processes we will use
for loading the data. For small
data like <code class="docutils literal notranslate"><span class="pre">Hitters</span></code> this will have little effect, but
it does provide an advantage for the <code class="docutils literal notranslate"><span class="pre">MNIST</span></code>  and <code class="docutils literal notranslate"><span class="pre">CIFAR100</span></code> examples below.
The <code class="docutils literal notranslate"><span class="pre">torch</span></code> package will inspect the process running and determine a
maximum number of workers. {This depends on the computing hardware and the number of cores available.} We’ve included a function
<code class="docutils literal notranslate"><span class="pre">rec_num_workers()</span></code> to compute this so we know how many
workers might be reasonable (here the max was 16).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_num_workers</span> <span class="o">=</span> <span class="n">rec_num_workers</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">max_num_workers</span> <span class="o">=</span> <span class="n">rec_num_workers</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;rec_num_workers&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The general training setup in <code class="docutils literal notranslate"><span class="pre">pytorch_lightning</span></code> involves
training, validation and test data. These are each
represented by different data loaders. During each epoch,
we run a training step to learn the model and a validation
step to track the error. The test data is typically
used at the end of training to evaluate the model.</p>
<p>In this case, as we had split only into test and training,
we’ll use the test data as validation data with the
argument <code class="docutils literal notranslate"><span class="pre">validation=hit_test</span></code>. The
<code class="docutils literal notranslate"><span class="pre">validation</span></code> argument can be a float between 0 and 1, an
integer, or a
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code>. If a float (respectively, integer), it is interpreted
as a percentage (respectively number) of the <em>training</em> observations to be used for validation.
If it is a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>, it is passed directly to a data loader.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">hit_train</span><span class="p">,</span>
                          <span class="n">hit_test</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                          <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">),</span>
                          <span class="n">validation</span><span class="o">=</span><span class="n">hit_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">hit_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">hit_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                           <span class="n">hit_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                           <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                           <span class="n">validation</span><span class="o">=</span><span class="n">hit_test</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleDataModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Next we must provide a <code class="docutils literal notranslate"><span class="pre">pytorch_lightning</span></code> module that controls
the steps performed during the training process. We provide methods for our
<code class="docutils literal notranslate"><span class="pre">SimpleModule()</span></code> that simply record the value
of the loss function and any additional
metrics at the end of each epoch. These operations
are controlled by the methods <code class="docutils literal notranslate"><span class="pre">SimpleModule.[training/test/validation]_step()</span></code>, though
we will not be modifying these in our examples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="n">hit_model</span><span class="p">,</span>
                           <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mae&#39;</span><span class="p">:</span><span class="n">MeanAbsoluteError</span><span class="p">()})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">hit_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="n">hit_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                            <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mae&#39;</span><span class="p">:</span><span class="n">MeanAbsoluteError</span><span class="p">()})</span>

<span class="ne">NameError</span>: name &#39;SimpleModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>By using the <code class="docutils literal notranslate"><span class="pre">SimpleModule.regression()</span></code> method,  we indicate that we will use squared-error loss as in
(10.23).
We have also asked for mean absolute error to be tracked as well
in the metrics that are logged.</p>
<p>We log our results via <code class="docutils literal notranslate"><span class="pre">CSVLogger()</span></code>, which in this case stores the results in a CSV file within a directory <code class="docutils literal notranslate"><span class="pre">logs/hitters</span></code>. After the fitting is complete, this allows us to load the
results as a <code class="docutils literal notranslate"><span class="pre">pd.DataFrame()</span></code> and visualize them below. There are
several ways to log the results within <code class="docutils literal notranslate"><span class="pre">pytorch_lightning</span></code>, though
we will not cover those here in detail.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hitters&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">26</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">hit_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hitters&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;CSVLogger&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Finally we are ready to train our model and log the results. We
use the <code class="docutils literal notranslate"><span class="pre">Trainer()</span></code> object from <code class="docutils literal notranslate"><span class="pre">pytorch_lightning</span></code>
to do this work. The argument <code class="docutils literal notranslate"><span class="pre">datamodule=hit_dm</span></code> tells the trainer
how training/validation/test logs are produced,
while the first argument <code class="docutils literal notranslate"><span class="pre">hit_module</span></code>
specifies the network architecture
as well as the training/validation/test steps.
The <code class="docutils literal notranslate"><span class="pre">callbacks</span></code> argument allows for
several tasks to be carried out at various
points while training a model. Here
our <code class="docutils literal notranslate"><span class="pre">ErrorTracker()</span></code> callback will enable
us to compute validation error while training
and, finally, the test error.
We now fit the model for 50 epochs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">max_epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                      <span class="n">log_every_n_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">logger</span><span class="o">=</span><span class="n">hit_logger</span><span class="p">,</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="n">hit_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">hit_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">hit_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">27</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">hit_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                       <span class="n">max_epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                       <span class="n">log_every_n_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                       <span class="n">logger</span><span class="o">=</span><span class="n">hit_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                       <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">hit_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">hit_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">hit_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;Trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>At each step of SGD, the algorithm randomly selects 32 training observations for
the computation of the gradient. Recall from Section 10.7
that an epoch amounts to the number of SGD steps required to process <span class="math notranslate nohighlight">\(n\)</span>
observations. Since the training set has
<span class="math notranslate nohighlight">\(n=175\)</span>, and we specified a <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> of 32 in the construction of  <code class="docutils literal notranslate"><span class="pre">hit_dm</span></code>, an epoch is <span class="math notranslate nohighlight">\(175/32=5.5\)</span> SGD steps.</p>
<p>After having fit the model, we can evaluate performance on our test
data using the <code class="docutils literal notranslate"><span class="pre">test()</span></code> method of our trainer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">hit_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">hit_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">28</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">hit_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">hit_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">hit_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;hit_trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The results of the fit have been logged into a CSV file. We can find the
results specific to this run in the <code class="docutils literal notranslate"><span class="pre">experiment.metrics_file_path</span></code>
attribute of our logger. Note that each time the model is fit, the logger will output
results into a new subdirectory of our directory <code class="docutils literal notranslate"><span class="pre">logs/hitters</span></code>.</p>
<p>We now create a plot of the MAE (mean absolute error) as a function of
the number of epochs.
First we retrieve the logged summaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">hit_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">hit_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">hit_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;hit_logger&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Since we will produce similar plots in later examples, we write a
simple generic function to produce this plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">summary_plot</span><span class="p">(</span><span class="n">results</span><span class="p">,</span>
                 <span class="n">ax</span><span class="p">,</span>
                 <span class="n">col</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span>
                 <span class="n">valid_legend</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">,</span>
                 <span class="n">training_legend</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">,</span>
                 <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Loss&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span>
         <span class="n">color</span><span class="p">,</span>
         <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;train_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_epoch&#39;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;valid_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span>
                       <span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;red&#39;</span><span class="p">],</span>
                       <span class="p">[</span><span class="n">training_legend</span><span class="p">,</span>
                        <span class="n">valid_legend</span><span class="p">]):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span>
                     <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                     <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
<p>We now set up our axes, and use our function to produce the MAE plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">summary_plot</span><span class="p">(</span><span class="n">hit_results</span><span class="p">,</span>
                  <span class="n">ax</span><span class="p">,</span>
                  <span class="n">col</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span>
                  <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span>
                  <span class="n">valid_legend</span><span class="o">=</span><span class="s1">&#39;Validation (=Test)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">summary_plot</span><span class="p">(</span><span class="n">hit_results</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                   <span class="n">ax</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                   <span class="n">col</span><span class="o">=</span><span class="s1">&#39;mae&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                   <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                   <span class="n">valid_legend</span><span class="o">=</span><span class="s1">&#39;Validation (=Test)&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span>

<span class="ne">NameError</span>: name &#39;hit_results&#39; is not defined
</pre></div>
</div>
<img alt="../../../_images/594160d58b20ad17cc3bd201bb81795a012c3c925f05d592dcab3ec7f86880e7.png" src="../../../_images/594160d58b20ad17cc3bd201bb81795a012c3c925f05d592dcab3ec7f86880e7.png" />
</div>
</div>
<p>We can predict directly from the final model, and
evaluate its performance on the test data.
Before fitting, we call the <code class="docutils literal notranslate"><span class="pre">eval()</span></code> method
of <code class="docutils literal notranslate"><span class="pre">hit_model</span></code>.
This tells
<code class="docutils literal notranslate"><span class="pre">torch</span></code> to effectively consider this model to be fitted, so that
we can use it to predict on new data. For our model here,
the biggest change is that the dropout layers will
be turned off, i.e. no weights will be randomly
dropped in predicting on new data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hit_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> 
<span class="n">preds</span> <span class="o">=</span> <span class="n">hit_module</span><span class="p">(</span><span class="n">X_test_t</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Y_test_t</span> <span class="o">-</span> <span class="n">preds</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">hit_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> 
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">hit_module</span><span class="p">(</span><span class="n">X_test_t</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Y_test_t</span> <span class="o">-</span> <span class="n">preds</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;hit_module&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="cleanup">
<h3>Cleanup<a class="headerlink" href="#cleanup" title="Permalink to this heading">#</a></h3>
<p>In setting up our data module, we had initiated
several worker processes that will remain running.
We delete all references to the torch objects to ensure these processes
will be killed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span><span class="p">(</span><span class="n">Hitters</span><span class="p">,</span>
    <span class="n">hit_model</span><span class="p">,</span> <span class="n">hit_dm</span><span class="p">,</span>
    <span class="n">hit_logger</span><span class="p">,</span>
    <span class="n">hit_test</span><span class="p">,</span> <span class="n">hit_train</span><span class="p">,</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span>
    <span class="n">X_test</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span>
    <span class="n">Y_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span>
    <span class="n">X_test_t</span><span class="p">,</span> <span class="n">Y_test_t</span><span class="p">,</span>
    <span class="n">hit_trainer</span><span class="p">,</span> <span class="n">hit_module</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">del</span><span class="p">(</span><span class="n">Hitters</span><span class="p">,</span>
<span class="ne">----&gt; </span><span class="mi">2</span>     <span class="n">hit_model</span><span class="p">,</span> <span class="n">hit_dm</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">hit_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">hit_test</span><span class="p">,</span> <span class="n">hit_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">X_test</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">Y_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">X_test_t</span><span class="p">,</span> <span class="n">Y_test_t</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">hit_trainer</span><span class="p">,</span> <span class="n">hit_module</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;hit_dm&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="multilayer-network-on-the-mnist-digit-data">
<h2>Multilayer Network on the MNIST Digit Data<a class="headerlink" href="#multilayer-network-on-the-mnist-digit-data" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">torchvision</span></code> package comes with a number of example datasets,
including the <code class="docutils literal notranslate"><span class="pre">MNIST</span></code>  digit data. Our first step is to retrieve
the training and test data sets; the <code class="docutils literal notranslate"><span class="pre">MNIST()</span></code> function within
<code class="docutils literal notranslate"><span class="pre">torchvision.datasets</span></code> is provided for this purpose. The
data will be downloaded the first time this function is executed, and stored in the directory <code class="docutils literal notranslate"><span class="pre">data/MNIST</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span> 
 <span class="n">mnist_test</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                      <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
                      <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">train</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]]</span>
<span class="n">mnist_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">34</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span> 
<span class="ne">----&gt; </span><span class="mi">2</span>  <span class="n">mnist_test</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                       <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                       <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                       <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">())</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                 <span class="k">for</span> <span class="n">train</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]]</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">mnist_train</span>

<span class="nn">Cell In[34], line 2,</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span> 
<span class="ne">----&gt; </span><span class="mi">2</span>  <span class="n">mnist_test</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                       <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                       <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                       <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">())</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                 <span class="k">for</span> <span class="n">train</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]]</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">mnist_train</span>

<span class="ne">NameError</span>: name &#39;MNIST&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>There are 60,000 images in the training data and 10,000 in the test
data. The images are <span class="math notranslate nohighlight">\(28\times 28\)</span>, and stored as a matrix of pixels. We
need to transform each one into a vector.</p>
<p>Neural networks are somewhat sensitive to the scale of the inputs, much as ridge and
lasso regularization are affected by scaling.  Here the inputs are eight-bit
grayscale values between 0 and 255, so we rescale to the unit
interval. {Note: eight bits means <span class="math notranslate nohighlight">\(2^8\)</span>, which equals 256. Since the convention
is to start at <span class="math notranslate nohighlight">\(0\)</span>, the possible values  range from <span class="math notranslate nohighlight">\(0\)</span> to <span class="math notranslate nohighlight">\(255\)</span>.}
This transformation, along with some reordering
of the axes, is performed by the <code class="docutils literal notranslate"><span class="pre">ToTensor()</span></code> transform
from the <code class="docutils literal notranslate"><span class="pre">torchvision.transforms</span></code> package.</p>
<p>As in our <code class="docutils literal notranslate"><span class="pre">Hitters</span></code> example, we form a data module
from the training and test datasets, setting aside 20%
of the training images for validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span>
                            <span class="n">mnist_test</span><span class="p">,</span>
                            <span class="n">validation</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                            <span class="n">num_workers</span><span class="o">=</span><span class="n">max_num_workers</span><span class="p">,</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mnist_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">mnist_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                             <span class="n">mnist_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                             <span class="n">validation</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                             <span class="n">num_workers</span><span class="o">=</span><span class="n">max_num_workers</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleDataModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at the data that will get fed into our network. We loop through the first few
chunks of the test dataset, breaking after 2 batches:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">X_</span> <span class="p">,</span><span class="n">Y_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mnist_dm</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X: &#39;</span><span class="p">,</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Y: &#39;</span><span class="p">,</span> <span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">X_</span> <span class="p">,</span><span class="n">Y_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mnist_dm</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X: &#39;</span><span class="p">,</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Y: &#39;</span><span class="p">,</span> <span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mnist_dm&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We see that the <span class="math notranslate nohighlight">\(X\)</span> for each batch consists of 256 images of size <code class="docutils literal notranslate"><span class="pre">1x28x28</span></code>.
Here the <code class="docutils literal notranslate"><span class="pre">1</span></code> indicates a single channel (greyscale). For RGB images such as <code class="docutils literal notranslate"><span class="pre">CIFAR100</span></code> below,
we will see that the <code class="docutils literal notranslate"><span class="pre">1</span></code> in the size will be replaced by <code class="docutils literal notranslate"><span class="pre">3</span></code> for the three RGB channels.</p>
<p>Now we are ready to specify our neural network.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MNISTModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MNISTModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">,</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We see that in the first layer, each <code class="docutils literal notranslate"><span class="pre">1x28x28</span></code> image is flattened, then mapped to
256 dimensions where we apply a ReLU activation with 40% dropout.
A second layer maps the first layer’s output down to
128 dimensions, applying a ReLU activation with 30% dropout. Finally,
the 128 dimensions are mapped down to 10, the number of classes in the
<code class="docutils literal notranslate"><span class="pre">MNIST</span></code>  data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_model</span> <span class="o">=</span> <span class="n">MNISTModel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can check that the model produces output of expected size based
on our existing batch <code class="docutils literal notranslate"><span class="pre">X_</span></code> above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_model</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">39</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mnist_model</span><span class="p">(</span><span class="n">X_</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;X_&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at the summary of the model. Instead of an <code class="docutils literal notranslate"><span class="pre">input_size</span></code> we can pass
a tensor of correct shape. In this case, we pass through the final
batched <code class="docutils literal notranslate"><span class="pre">X_</span></code> from above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary</span><span class="p">(</span><span class="n">mnist_model</span><span class="p">,</span>
        <span class="n">input_data</span><span class="o">=</span><span class="n">X_</span><span class="p">,</span>
        <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">summary</span><span class="p">(</span><span class="n">mnist_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>         <span class="n">input_data</span><span class="o">=</span><span class="n">X_</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                    <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                    <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;summary&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Having set up both  the model and the data module, fitting this model is
now almost identical to the <code class="docutils literal notranslate"><span class="pre">Hitters</span></code> example. In contrast to our regression model, here we will use the
<code class="docutils literal notranslate"><span class="pre">SimpleModule.classification()</span></code> method which
uses the  cross-entropy loss function instead of mean squared error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">classification</span><span class="p">(</span><span class="n">mnist_model</span><span class="p">)</span>
<span class="n">mnist_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MNIST&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">41</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mnist_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">classification</span><span class="p">(</span><span class="n">mnist_model</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mnist_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MNIST&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to go. The final step is to supply training data, and fit the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                        <span class="n">logger</span><span class="o">=</span><span class="n">mnist_logger</span><span class="p">,</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="n">mnist_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mnist_module</span><span class="p">,</span>
                  <span class="n">datamodule</span><span class="o">=</span><span class="n">mnist_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mnist_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                         <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                         <span class="n">logger</span><span class="o">=</span><span class="n">mnist_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                         <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">mnist_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mnist_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                   <span class="n">datamodule</span><span class="o">=</span><span class="n">mnist_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;Trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We have suppressed the output here, which is a progress report on the
fitting of the model, grouped by epoch. This is very useful, since on
large datasets fitting can take time. Fitting this model took 245
seconds on a MacBook Pro with an Apple M1 Pro chip with 10 cores and 16 GB of RAM.
Here we specified a
validation split of 20%, so training is actually performed on
80% of the 60,000 observations in the training set. This is an
alternative to actually supplying validation data, like we did for the <code class="docutils literal notranslate"><span class="pre">Hitters</span></code> data.
SGD  uses batches
of 256 observations in computing the gradient, and doing the
arithmetic, we see that an epoch corresponds to 188 gradient steps.</p>
<p><code class="docutils literal notranslate"><span class="pre">SimpleModule.classification()</span></code> includes
an accuracy metric by default. Other
classification metrics can be added from <code class="docutils literal notranslate"><span class="pre">torchmetrics</span></code>.
We will use  our <code class="docutils literal notranslate"><span class="pre">summary_plot()</span></code> function to display
accuracy across epochs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">mnist_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">summary_plot</span><span class="p">(</span><span class="n">mnist_results</span><span class="p">,</span>
             <span class="n">ax</span><span class="p">,</span>
             <span class="n">col</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
             <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">43</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mnist_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">mnist_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">summary_plot</span><span class="p">(</span><span class="n">mnist_results</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>              <span class="n">ax</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>              <span class="n">col</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>              <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mnist_logger&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Once again we evaluate the accuracy using the <code class="docutils literal notranslate"><span class="pre">test()</span></code> method of our trainer. This model achieves
97% accuracy on the test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">mnist_module</span><span class="p">,</span>
                   <span class="n">datamodule</span><span class="o">=</span><span class="n">mnist_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">44</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mnist_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">mnist_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                    <span class="n">datamodule</span><span class="o">=</span><span class="n">mnist_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mnist_trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Table 10.1 also reports the error rates resulting from LDA (Chapter 4) and multiclass logistic
regression. For LDA we refer the reader to Section 4.7.3.
Although we could use the <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> function <code class="docutils literal notranslate"><span class="pre">LogisticRegression()</span></code> to fit<br />
multiclass logistic regression, we are set up here to fit such a model
with <code class="docutils literal notranslate"><span class="pre">torch</span></code>.
We just have an input layer and an output layer, and omit the hidden layers!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MNIST_MLR</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MNIST_MLR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
                                    <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">784</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">mlr_model</span> <span class="o">=</span> <span class="n">MNIST_MLR</span><span class="p">()</span>
<span class="n">mlr_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">classification</span><span class="p">(</span><span class="n">mlr_model</span><span class="p">)</span>
<span class="n">mlr_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MNIST_MLR&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">45</span><span class="p">],</span> <span class="n">line</span> <span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="n">mlr_model</span> <span class="o">=</span> <span class="n">MNIST_MLR</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="n">mlr_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">classification</span><span class="p">(</span><span class="n">mlr_model</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">mlr_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MNIST_MLR&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mlr_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="n">mlr_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mlr_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">mnist_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">46</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mlr_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                       <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                       <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">mlr_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mlr_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">mnist_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;Trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We fit the model just as before and compute the test results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mlr_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">mlr_module</span><span class="p">,</span>
                 <span class="n">datamodule</span><span class="o">=</span><span class="n">mnist_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">47</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mlr_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">mlr_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                  <span class="n">datamodule</span><span class="o">=</span><span class="n">mnist_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mlr_trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The accuracy is above 90% even for this pretty simple model.</p>
<p>As in the <code class="docutils literal notranslate"><span class="pre">Hitters</span></code> example, we delete some of
the objects we created above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span><span class="p">(</span><span class="n">mnist_test</span><span class="p">,</span>
    <span class="n">mnist_train</span><span class="p">,</span>
    <span class="n">mnist_model</span><span class="p">,</span>
    <span class="n">mnist_dm</span><span class="p">,</span>
    <span class="n">mnist_trainer</span><span class="p">,</span>
    <span class="n">mnist_module</span><span class="p">,</span>
    <span class="n">mnist_results</span><span class="p">,</span>
    <span class="n">mlr_model</span><span class="p">,</span>
    <span class="n">mlr_module</span><span class="p">,</span>
    <span class="n">mlr_trainer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">48</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">del</span><span class="p">(</span><span class="n">mnist_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">mnist_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">mnist_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">mnist_dm</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">mnist_trainer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">mnist_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">mnist_results</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">mlr_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">mlr_module</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="n">mlr_trainer</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;mnist_test&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="convolutional-neural-networks">
<h2>Convolutional Neural Networks<a class="headerlink" href="#convolutional-neural-networks" title="Permalink to this heading">#</a></h2>
<p>In this section we fit a CNN to the <code class="docutils literal notranslate"><span class="pre">CIFAR100</span></code> data, which is available in the <code class="docutils literal notranslate"><span class="pre">torchvision</span></code>
package. It is arranged in a similar fashion as the <code class="docutils literal notranslate"><span class="pre">MNIST</span></code> data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cifar_train</span><span class="p">,</span> 
 <span class="n">cifar_test</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIFAR100</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
                         <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
                         <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">train</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">49</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="p">(</span><span class="n">cifar_train</span><span class="p">,</span> 
<span class="ne">----&gt; </span><span class="mi">2</span>  <span class="n">cifar_test</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIFAR100</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                          <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                          <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>              <span class="k">for</span> <span class="n">train</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]]</span>

<span class="nn">Cell In[49], line 2,</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="p">(</span><span class="n">cifar_train</span><span class="p">,</span> 
<span class="ne">----&gt; </span><span class="mi">2</span>  <span class="n">cifar_test</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIFAR100</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                          <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                          <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>              <span class="k">for</span> <span class="n">train</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]]</span>

<span class="ne">NameError</span>: name &#39;CIFAR100&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()</span>
<span class="n">cifar_train_X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">cifar_train</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="n">cifar_test_X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                            <span class="n">cifar_test</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="n">cifar_train</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">cifar_train_X</span><span class="p">,</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cifar_train</span><span class="o">.</span><span class="n">targets</span><span class="p">))</span>
<span class="n">cifar_test</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">cifar_test_X</span><span class="p">,</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cifar_test</span><span class="o">.</span><span class="n">targets</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">50</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">cifar_train_X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                             <span class="n">cifar_train</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">cifar_test_X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                             <span class="n">cifar_test</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;ToTensor&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">CIFAR100</span></code> dataset consists of 50,000 training images, each represented by a three-dimensional tensor:
each three-color image is represented as a set of three channels, each of which consists of
<span class="math notranslate nohighlight">\(32\times 32\)</span> eight-bit pixels. We standardize as we did for the
digits, but keep the array structure. This is accomplished with the <code class="docutils literal notranslate"><span class="pre">ToTensor()</span></code> transform.</p>
<p>Creating the data module is similar to the <code class="docutils literal notranslate"><span class="pre">MNIST</span></code>  example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cifar_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">cifar_train</span><span class="p">,</span>
                            <span class="n">cifar_test</span><span class="p">,</span>
                            <span class="n">validation</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                            <span class="n">num_workers</span><span class="o">=</span><span class="n">max_num_workers</span><span class="p">,</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">51</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">cifar_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">cifar_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                             <span class="n">cifar_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                             <span class="n">validation</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                             <span class="n">num_workers</span><span class="o">=</span><span class="n">max_num_workers</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleDataModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We again look at the shape of typical batches in our data loaders.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">X_</span> <span class="p">,</span><span class="n">Y_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cifar_dm</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X: &#39;</span><span class="p">,</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Y: &#39;</span><span class="p">,</span> <span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">52</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">X_</span> <span class="p">,</span><span class="n">Y_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cifar_dm</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X: &#39;</span><span class="p">,</span> <span class="n">X_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Y: &#39;</span><span class="p">,</span> <span class="n">Y_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;cifar_dm&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Before we start, we look at some of the training images; similar code produced
Figure 10.5 on page  445. The example below also illustrates
that <code class="docutils literal notranslate"><span class="pre">TensorDataset</span></code> objects can be indexed with integers — we are choosing
random images from the training data by indexing <code class="docutils literal notranslate"><span class="pre">cifar_train</span></code>. In order to display correctly,
we must reorder the dimensions by a call to <code class="docutils literal notranslate"><span class="pre">np.transpose()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cifar_train</span><span class="p">)),</span> <span class="mi">25</span><span class="p">,</span>
                     <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cifar_train</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span>
                                      <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">53</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cifar_train</span><span class="p">)),</span> <span class="mi">25</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                      <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>

<span class="ne">NameError</span>: name &#39;cifar_train&#39; is not defined
</pre></div>
</div>
<img alt="../../../_images/2f2f1b232d53f2fdd3522f6a2407ccb7f8f0b7ba12889f8075dd4bdee9260d36.png" src="../../../_images/2f2f1b232d53f2fdd3522f6a2407ccb7f8f0b7ba12889f8075dd4bdee9260d36.png" />
</div>
</div>
<p>Here the <code class="docutils literal notranslate"><span class="pre">imshow()</span></code> method recognizes from the shape of its argument that it is a 3-dimensional array, with the last dimension indexing the three RGB color channels.</p>
<p>We specify a moderately-sized  CNN for
demonstration purposes, similar in structure to Figure 10.8.
We use several layers, each consisting of  convolution, ReLU, and max-pooling steps.
We first define a module that defines one of these layers. As in our
previous examples, we overwrite the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> and <code class="docutils literal notranslate"><span class="pre">forward()</span></code> methods
of <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>. This user-defined  module can now be used in ways just like
<code class="docutils literal notranslate"><span class="pre">nn.Linear()</span></code> or <code class="docutils literal notranslate"><span class="pre">nn.Dropout()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BuildingBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">in_channels</span><span class="p">,</span>
                 <span class="n">out_channels</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">BuildingBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span>
                              <span class="n">out_channels</span><span class="o">=</span><span class="n">out_channels</span><span class="p">,</span>
                              <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                              <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Notice that we used the <code class="docutils literal notranslate"><span class="pre">padding</span> <span class="pre">=</span> <span class="pre">&quot;same&quot;</span></code> argument to
<code class="docutils literal notranslate"><span class="pre">nn.Conv2d()</span></code>, which ensures that the output channels have the
same dimension as the input channels. There are 32 channels in the first
hidden layer, in contrast to the three channels in the input layer. We
use a <span class="math notranslate nohighlight">\(3\times 3\)</span> convolution filter for each channel in all the layers. Each
convolution is followed by a max-pooling layer over <span class="math notranslate nohighlight">\(2\times2\)</span>
blocks.</p>
<p>In forming our deep learning model for the <code class="docutils literal notranslate"><span class="pre">CIFAR100</span></code> data, we use several of our <code class="docutils literal notranslate"><span class="pre">BuildingBlock()</span></code>
modules sequentially. This simple example
illustrates some of the power of <code class="docutils literal notranslate"><span class="pre">torch</span></code>. Users can
define modules of their own, which can be combined in other
modules. Ultimately, everything is fit by a generic trainer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CIFARModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CIFARModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span><span class="mi">32</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="mi">128</span><span class="p">),</span>
                 <span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="mi">256</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">BuildingBlock</span><span class="p">(</span><span class="n">in_</span><span class="p">,</span> <span class="n">out_</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">in_</span><span class="p">,</span> <span class="n">out_</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
                                    <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
                                    <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
                                    <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We  build the model and look at the summary. (We had created examples of <code class="docutils literal notranslate"><span class="pre">X_</span></code> earlier.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cifar_model</span> <span class="o">=</span> <span class="n">CIFARModel</span><span class="p">()</span>
<span class="n">summary</span><span class="p">(</span><span class="n">cifar_model</span><span class="p">,</span>
        <span class="n">input_data</span><span class="o">=</span><span class="n">X_</span><span class="p">,</span>
        <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">56</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">cifar_model</span> <span class="o">=</span> <span class="n">CIFARModel</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">summary</span><span class="p">(</span><span class="n">cifar_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="n">input_data</span><span class="o">=</span><span class="n">X_</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                    <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                    <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;summary&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The total number of trainable parameters is 964,516.
By studying the size of the parameters, we can see that the channels halve in both
dimensions
after each of these max-pooling operations. After the last of these we
have a layer with  256 channels of dimension <span class="math notranslate nohighlight">\(2\times 2\)</span>. These are then
flattened to a dense layer of size 1,024;
in other words, each of the <span class="math notranslate nohighlight">\(2\times 2\)</span> matrices is turned into a
<span class="math notranslate nohighlight">\(4\)</span>-vector, and put side-by-side in one layer. This is followed by a
dropout regularization layer,  then
another dense layer of size 512, and finally, the
output layer.</p>
<p>Up to now, we have been using a default
optimizer in <code class="docutils literal notranslate"><span class="pre">SimpleModule()</span></code>. For these data,
experiments show that a smaller learning rate performs
better than the default 0.01. We use a
custom optimizer here with a learning rate of 0.001.
Besides this, the logging and training
follow a similar pattern to our previous examples. The optimizer
takes an argument <code class="docutils literal notranslate"><span class="pre">params</span></code> that informs
the optimizer which parameters are involved in SGD (stochastic gradient descent).</p>
<p>We saw earlier that entries of a module’s parameters are tensors. In passing
the parameters to the optimizer we are doing more than
simply passing arrays; part of the structure of the graph
is encoded in the tensors themselves.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cifar_optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">cifar_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">cifar_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">classification</span><span class="p">(</span><span class="n">cifar_model</span><span class="p">,</span>
                                    <span class="n">optimizer</span><span class="o">=</span><span class="n">cifar_optimizer</span><span class="p">)</span>
<span class="n">cifar_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CIFAR100&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">57</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">cifar_optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">cifar_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">cifar_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">classification</span><span class="p">(</span><span class="n">cifar_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                                     <span class="n">optimizer</span><span class="o">=</span><span class="n">cifar_optimizer</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">cifar_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CIFAR100&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cifar_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                        <span class="n">logger</span><span class="o">=</span><span class="n">cifar_logger</span><span class="p">,</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="n">cifar_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cifar_module</span><span class="p">,</span>
                  <span class="n">datamodule</span><span class="o">=</span><span class="n">cifar_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">58</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">cifar_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                         <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                         <span class="n">logger</span><span class="o">=</span><span class="n">cifar_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                         <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">cifar_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cifar_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                   <span class="n">datamodule</span><span class="o">=</span><span class="n">cifar_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;Trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>This model takes 10 minutes or more to run and achieves about 42% accuracy on the test
data. Although this is not terrible for 100-class data (a random
classifier gets 1% accuracy), searching the web we see results around
75%. Typically it takes a lot of architecture carpentry,
fiddling with regularization, and time, to achieve such results.</p>
<p>Let’s take a look at the validation and training accuracy
across epochs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">log_path</span> <span class="o">=</span> <span class="n">cifar_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span>
<span class="n">cifar_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">summary_plot</span><span class="p">(</span><span class="n">cifar_results</span><span class="p">,</span>
             <span class="n">ax</span><span class="p">,</span>
             <span class="n">col</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
             <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">59</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">log_path</span> <span class="o">=</span> <span class="n">cifar_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">cifar_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;cifar_logger&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Finally, we evaluate our model on our test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cifar_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">cifar_module</span><span class="p">,</span>
                   <span class="n">datamodule</span><span class="o">=</span><span class="n">cifar_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">60</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">cifar_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">cifar_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                    <span class="n">datamodule</span><span class="o">=</span><span class="n">cifar_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;cifar_trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<section id="hardware-acceleration">
<h3>Hardware Acceleration<a class="headerlink" href="#hardware-acceleration" title="Permalink to this heading">#</a></h3>
<p>As deep learning has become ubiquitous in machine learning, hardware
manufacturers have produced special libraries that can
often speed up the gradient-descent steps.</p>
<p>For instance, Mac OS devices with the M1 chip may have the <em>Metal</em> programming framework
enabled, which can speed up the  <code class="docutils literal notranslate"><span class="pre">torch</span></code>
computations. We present an example of how to use this acceleration.</p>
<p>The main changes are to the <code class="docutils literal notranslate"><span class="pre">Trainer()</span></code> call as well as to the metrics
that will be evaluated on the data. These metrics must be told  where
the data will be located at evaluation time. This is
accomplished with a call to the <code class="docutils literal notranslate"><span class="pre">to()</span></code> method of the metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">cifar_module</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cifar_module</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span><span class="p">)</span>
    <span class="n">cifar_trainer_mps</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">accelerator</span><span class="o">=</span><span class="s1">&#39;mps&#39;</span><span class="p">,</span>
                                <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">cifar_trainer_mps</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cifar_module</span><span class="p">,</span>
                          <span class="n">datamodule</span><span class="o">=</span><span class="n">cifar_dm</span><span class="p">)</span>
    <span class="n">cifar_trainer_mps</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">cifar_module</span><span class="p">,</span>
                          <span class="n">datamodule</span><span class="o">=</span><span class="n">cifar_dm</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>This yields approximately two- or three-fold  acceleration for each epoch.
We have protected this code block using <code class="docutils literal notranslate"><span class="pre">try:</span></code> and <code class="docutils literal notranslate"><span class="pre">except:</span></code>
clauses; if it works, we get the speedup, if it fails, nothing happens.</p>
</section>
</section>
<section id="using-pretrained-cnn-models">
<h2>Using Pretrained CNN Models<a class="headerlink" href="#using-pretrained-cnn-models" title="Permalink to this heading">#</a></h2>
<p>We now show how to use a CNN pretrained on the  <code class="docutils literal notranslate"><span class="pre">imagenet</span></code> database to classify natural
images, and demonstrate how we produced Figure 10.10.
We copied six JPEG images from a digital photo album into the
directory <code class="docutils literal notranslate"><span class="pre">book_images</span></code>. These images are available
from the data section of  &lt;<a class="reference external" href="http://www.statlearning.com">www.statlearning.com</a>&gt;, the ISLP book website. Download <code class="docutils literal notranslate"><span class="pre">book_images.zip</span></code>; when
clicked it creates the <code class="docutils literal notranslate"><span class="pre">book_images</span></code> directory.</p>
<p>The pretrained network we use is called <code class="docutils literal notranslate"><span class="pre">resnet50</span></code>; specification details can be found on the web.
We will read in the images, and
convert them into the array format expected by the <code class="docutils literal notranslate"><span class="pre">torch</span></code>
software to match the specifications in <code class="docutils literal notranslate"><span class="pre">resnet50</span></code>.
The conversion involves a resize, a crop and then a predefined standardization for each of the three channels.
We now read in the images and preprocess them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resize</span> <span class="o">=</span> <span class="n">Resize</span><span class="p">((</span><span class="mi">232</span><span class="p">,</span><span class="mi">232</span><span class="p">))</span>
<span class="n">crop</span> <span class="o">=</span> <span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
<span class="n">normalize</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span><span class="mf">0.456</span><span class="p">,</span><span class="mf">0.406</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span><span class="mf">0.224</span><span class="p">,</span><span class="mf">0.225</span><span class="p">])</span>
<span class="n">imgfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;book_images/*&#39;</span><span class="p">)])</span>
<span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">crop</span><span class="p">(</span><span class="n">resize</span><span class="p">(</span><span class="n">read_image</span><span class="p">(</span><span class="n">f</span><span class="p">))),</span> <span class="mi">255</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">imgfiles</span><span class="p">])</span>
<span class="n">imgs</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
<span class="n">imgs</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">62</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">resize</span> <span class="o">=</span> <span class="n">Resize</span><span class="p">((</span><span class="mi">232</span><span class="p">,</span><span class="mi">232</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">crop</span> <span class="o">=</span> <span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span><span class="mf">0.456</span><span class="p">,</span><span class="mf">0.406</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                       <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span><span class="mf">0.224</span><span class="p">,</span><span class="mf">0.225</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;Resize&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We now set up the trained network with the weights we read in code block~6. The model has 50 layers, with a fair bit of complexity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resnet_model</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">ResNet50_Weights</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">)</span>
<span class="n">summary</span><span class="p">(</span><span class="n">resnet_model</span><span class="p">,</span>
        <span class="n">input_data</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span>
        <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">63</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">resnet_model</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">ResNet50_Weights</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">summary</span><span class="p">(</span><span class="n">resnet_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="n">input_data</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                    <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                    <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;resnet50&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We set the mode to <code class="docutils literal notranslate"><span class="pre">eval()</span></code> to ensure that the model is ready to predict on new data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resnet_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">resnet_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;resnet_model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Inspecting the output above, we see that when setting up the
<code class="docutils literal notranslate"><span class="pre">resnet_model</span></code>, the authors defined a <code class="docutils literal notranslate"><span class="pre">Bottleneck</span></code>, much like our
<code class="docutils literal notranslate"><span class="pre">BuildingBlock</span></code> module.</p>
<p>We now feed our six images through the fitted network.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img_preds</span> <span class="o">=</span> <span class="n">resnet_model</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">65</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">img_preds</span> <span class="o">=</span> <span class="n">resnet_model</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;resnet_model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Let’s look at the predicted probabilities for each of the top 3 choices. First we compute
the probabilities by applying the softmax to the logits in <code class="docutils literal notranslate"><span class="pre">img_preds</span></code>. Note that
we have had to call the <code class="docutils literal notranslate"><span class="pre">detach()</span></code> method on the tensor <code class="docutils literal notranslate"><span class="pre">img_preds</span></code> in order to convert
it to our a more familiar <code class="docutils literal notranslate"><span class="pre">ndarray</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img_preds</span><span class="o">.</span><span class="n">detach</span><span class="p">()))</span>
<span class="n">img_probs</span> <span class="o">/=</span> <span class="n">img_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">66</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">img_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img_preds</span><span class="o">.</span><span class="n">detach</span><span class="p">()))</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">img_probs</span> <span class="o">/=</span> <span class="n">img_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>

<span class="ne">NameError</span>: name &#39;img_preds&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>In order to see the class labels, we must download the index file associated with <code class="docutils literal notranslate"><span class="pre">imagenet</span></code>. {This is avalable from the book website and  <a class="reference external" href="https://s3.amazonaws.com/deep-learning-models/image-models/imagenet_class_index.json">s3.amazonaws.com/deep-learning-models/image-models/imagenet_class_index.json</a>.}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;imagenet_class_index.json&#39;</span><span class="p">))</span>
<span class="n">class_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> 
                           <span class="n">labs</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
                           <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>
<span class="n">class_labels</span> <span class="o">=</span> <span class="n">class_labels</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;idx&#39;</span><span class="p">)</span>
<span class="n">class_labels</span> <span class="o">=</span> <span class="n">class_labels</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">67</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">labs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;imagenet_class_index.json&#39;</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">class_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span>                            <span class="n">labs</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">class_labels</span> <span class="o">=</span> <span class="n">class_labels</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;idx&#39;</span><span class="p">)</span>

<span class="nn">File ~/work/isl/isl/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py:284,</span> in <span class="ni">_modified_open</span><span class="nt">(file, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">277</span> <span class="k">if</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}:</span>
<span class="g g-Whitespace">    </span><span class="mi">278</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">279</span>         <span class="sa">f</span><span class="s2">&quot;IPython won&#39;t let you open fd=</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> by default &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">280</span>         <span class="s2">&quot;as it is likely to crash IPython. If you know what you are doing, &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">281</span>         <span class="s2">&quot;you can use builtins&#39; open.&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">282</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">284</span> <span class="k">return</span> <span class="n">io_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;imagenet_class_index.json&#39;
</pre></div>
</div>
</div>
</div>
<p>We’ll now construct a data frame for each image file
with the labels with the three highest probabilities as
estimated by the model above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">imgfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imgfiles</span><span class="p">):</span>
    <span class="n">img_df</span> <span class="o">=</span> <span class="n">class_labels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">img_df</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">img_df</span> <span class="o">=</span> <span class="n">img_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;prob&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image: </span><span class="si">{</span><span class="n">imgfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">img_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">68</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">imgfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imgfiles</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">img_df</span> <span class="o">=</span> <span class="n">class_labels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">img_df</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="ne">NameError</span>: name &#39;imgfiles&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We see that the model
is quite confident about <code class="docutils literal notranslate"><span class="pre">Flamingo.jpg</span></code>, but a little less so for the
other images.</p>
<p>We end this section with our usual cleanup.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span><span class="p">(</span><span class="n">cifar_test</span><span class="p">,</span>
    <span class="n">cifar_train</span><span class="p">,</span>
    <span class="n">cifar_dm</span><span class="p">,</span>
    <span class="n">cifar_module</span><span class="p">,</span>
    <span class="n">cifar_logger</span><span class="p">,</span>
    <span class="n">cifar_optimizer</span><span class="p">,</span>
    <span class="n">cifar_trainer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">69</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">del</span><span class="p">(</span><span class="n">cifar_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">cifar_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">cifar_dm</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">cifar_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">cifar_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">cifar_optimizer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">cifar_trainer</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;cifar_test&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="imdb-document-classification">
<h2>IMDB Document Classification<a class="headerlink" href="#imdb-document-classification" title="Permalink to this heading">#</a></h2>
<p>We now implement models for sentiment classification (Section 10.4)  on the <code class="docutils literal notranslate"><span class="pre">IMDB</span></code>
dataset. As mentioned above code block~8, we are using
a preprocessed version of the <code class="docutils literal notranslate"><span class="pre">IMDB</span></code> dataset found in the
<code class="docutils literal notranslate"><span class="pre">keras</span></code> package. As <code class="docutils literal notranslate"><span class="pre">keras</span></code> uses <code class="docutils literal notranslate"><span class="pre">tensorflow</span></code>, a different
tensor and deep learning library, we have
converted the data to be suitable for <code class="docutils literal notranslate"><span class="pre">torch</span></code>. The
code used to convert from <code class="docutils literal notranslate"><span class="pre">keras</span></code> is
available in the module <code class="docutils literal notranslate"><span class="pre">ISLP.torch._make_imdb</span></code>. It
requires some of the <code class="docutils literal notranslate"><span class="pre">keras</span></code> packages to run. These data use a dictionary of size 10,000.</p>
<p>We have stored three different representations of the review data for this lab:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">load_tensor()</span></code>, a sparse tensor version usable by <code class="docutils literal notranslate"><span class="pre">torch</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_sparse()</span></code>, a sparse matrix version usable by <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>, since we will compare with a lasso fit;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load_sequential()</span></code>, a padded
version of the original sequence representation, limited to the last
500 words of each review.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">imdb_seq_train</span><span class="p">,</span>
 <span class="n">imdb_seq_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_sequential</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data/IMDB&#39;</span><span class="p">)</span>
<span class="n">padded_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imdb_seq_train</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sample_review</span> <span class="o">=</span> <span class="n">padded_sample</span><span class="p">[</span><span class="n">padded_sample</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][:</span><span class="mi">12</span><span class="p">]</span>
<span class="n">sample_review</span><span class="p">[:</span><span class="mi">12</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">70</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="p">(</span><span class="n">imdb_seq_train</span><span class="p">,</span>
<span class="ne">----&gt; </span><span class="mi">2</span>  <span class="n">imdb_seq_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_sequential</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data/IMDB&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">padded_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imdb_seq_train</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">sample_review</span> <span class="o">=</span> <span class="n">padded_sample</span><span class="p">[</span><span class="n">padded_sample</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][:</span><span class="mi">12</span><span class="p">]</span>

<span class="ne">NameError</span>: name &#39;load_sequential&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The datasets <code class="docutils literal notranslate"><span class="pre">imdb_seq_train</span></code> and <code class="docutils literal notranslate"><span class="pre">imdb_seq_test</span></code> are
both instances of the class <code class="docutils literal notranslate"><span class="pre">TensorDataset</span></code>. The
tensors used to construct them can be found in the <code class="docutils literal notranslate"><span class="pre">tensors</span></code> attribute, with
the first tensor  the features <code class="docutils literal notranslate"><span class="pre">X</span></code> and the second  the outcome <code class="docutils literal notranslate"><span class="pre">Y</span></code>.
We have taken the first row of features and stored it as <code class="docutils literal notranslate"><span class="pre">padded_sample</span></code>. In the preprocessing
used to form these data, sequences were padded with 0s in the beginning if they were
not long enough, hence we remove this padding by restricting to entries where
<code class="docutils literal notranslate"><span class="pre">padded_sample</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>. We then provide the first 12 words of the sample review.</p>
<p>We can find these words in the <code class="docutils literal notranslate"><span class="pre">lookup</span></code> dictionary from the <code class="docutils literal notranslate"><span class="pre">ISLP.torch.imdb</span></code> module.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lookup</span> <span class="o">=</span> <span class="n">load_lookup</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data/IMDB&#39;</span><span class="p">)</span>
<span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lookup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sample_review</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">71</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lookup</span> <span class="o">=</span> <span class="n">load_lookup</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data/IMDB&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lookup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sample_review</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;load_lookup&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>For our first model, we have created a binary feature for each
of the 10,000 possible words in the dataset, with an entry of one
in the <span class="math notranslate nohighlight">\(i,j\)</span> entry if word <span class="math notranslate nohighlight">\(j\)</span> appears in review <span class="math notranslate nohighlight">\(i\)</span>. As most reviews
are quite short, such a feature matrix has over 98% zeros. These data
are accessed using <code class="docutils literal notranslate"><span class="pre">load_tensor()</span></code> from the <code class="docutils literal notranslate"><span class="pre">ISLP</span></code> library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_num_workers</span><span class="o">=</span><span class="mi">10</span>
<span class="p">(</span><span class="n">imdb_train</span><span class="p">,</span>
 <span class="n">imdb_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_tensor</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data/IMDB&#39;</span><span class="p">)</span>
<span class="n">imdb_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">imdb_train</span><span class="p">,</span>
                           <span class="n">imdb_test</span><span class="p">,</span>
                           <span class="n">validation</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                           <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">),</span>
                           <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">72</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">max_num_workers</span><span class="o">=</span><span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="p">(</span><span class="n">imdb_train</span><span class="p">,</span>
<span class="ne">----&gt; </span><span class="mi">3</span>  <span class="n">imdb_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_tensor</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;data/IMDB&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">imdb_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">imdb_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                            <span class="n">imdb_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                            <span class="n">validation</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                            <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;load_tensor&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We’ll use a two-layer model for our first model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IMDBModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IMDBModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">_map</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">_map</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now instantiate our model and look at a summary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imdb_model</span> <span class="o">=</span> <span class="n">IMDBModel</span><span class="p">(</span><span class="n">imdb_test</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">summary</span><span class="p">(</span><span class="n">imdb_model</span><span class="p">,</span>
        <span class="n">input_size</span><span class="o">=</span><span class="n">imdb_test</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
        <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">74</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">imdb_model</span> <span class="o">=</span> <span class="n">IMDBModel</span><span class="p">(</span><span class="n">imdb_test</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">summary</span><span class="p">(</span><span class="n">imdb_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="n">input_size</span><span class="o">=</span><span class="n">imdb_test</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                    <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                    <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;imdb_test&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We’ll again use
a smaller learning rate for these data,
hence we pass an <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> to the
<code class="docutils literal notranslate"><span class="pre">SimpleModule</span></code>.
Since the reviews are classified into
positive or negative sentiment, we use
<code class="docutils literal notranslate"><span class="pre">SimpleModule.binary_classification()</span></code>. {Our use of
<code class="docutils literal notranslate"><span class="pre">binary_classification()</span></code> instead of  <code class="docutils literal notranslate"><span class="pre">classification()</span></code> is
due to some subtlety in how <code class="docutils literal notranslate"><span class="pre">torchmetrics.Accuracy()</span></code> works,
as well as the data type of the targets.}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imdb_optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">imdb_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">imdb_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">binary_classification</span><span class="p">(</span>
                         <span class="n">imdb_model</span><span class="p">,</span>
                         <span class="n">optimizer</span><span class="o">=</span><span class="n">imdb_optimizer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">75</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">imdb_optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">imdb_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">imdb_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">binary_classification</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                          <span class="n">imdb_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                          <span class="n">optimizer</span><span class="o">=</span><span class="n">imdb_optimizer</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;imdb_model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Having loaded the datasets into a data module
and created a <code class="docutils literal notranslate"><span class="pre">SimpleModule</span></code>, the remaining steps
are familiar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imdb_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;IMDB&#39;</span><span class="p">)</span>
<span class="n">imdb_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                       <span class="n">logger</span><span class="o">=</span><span class="n">imdb_logger</span><span class="p">,</span>
                       <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="n">imdb_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">imdb_module</span><span class="p">,</span>
                 <span class="n">datamodule</span><span class="o">=</span><span class="n">imdb_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">76</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">imdb_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;IMDB&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">imdb_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                        <span class="n">max_epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                        <span class="n">logger</span><span class="o">=</span><span class="n">imdb_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">imdb_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">imdb_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                  <span class="n">datamodule</span><span class="o">=</span><span class="n">imdb_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;CSVLogger&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Evaluating the test error yields roughly 86% accuracy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_results</span> <span class="o">=</span> <span class="n">imdb_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">imdb_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">imdb_dm</span><span class="p">)</span>
<span class="n">test_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">77</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">test_results</span> <span class="o">=</span> <span class="n">imdb_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">imdb_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">imdb_dm</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">test_results</span>

<span class="ne">NameError</span>: name &#39;imdb_trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<section id="comparison-to-lasso">
<h3>Comparison to Lasso<a class="headerlink" href="#comparison-to-lasso" title="Permalink to this heading">#</a></h3>
<p>We now fit a lasso logistic regression model
using <code class="docutils literal notranslate"><span class="pre">LogisticRegression()</span></code> from <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>. Since <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> does not recognize
the sparse tensors of <code class="docutils literal notranslate"><span class="pre">torch</span></code>, we use a sparse
matrix that is recognized by <code class="docutils literal notranslate"><span class="pre">sklearn.</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">((</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">),</span>
 <span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">),</span>
 <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">))</span> <span class="o">=</span> <span class="n">load_sparse</span><span class="p">(</span><span class="n">validation</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                                 <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">root</span><span class="o">=</span><span class="s1">&#39;data/IMDB&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">78</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="p">((</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>  <span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">),</span>
<span class="ne">----&gt; </span><span class="mi">3</span>  <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">))</span> <span class="o">=</span> <span class="n">load_sparse</span><span class="p">(</span><span class="n">validation</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                                  <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                                  <span class="n">root</span><span class="o">=</span><span class="s1">&#39;data/IMDB&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;load_sparse&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Similar to what we did in
Section 10.9.1,
we construct a series of 50 values for the lasso reguralization parameter <span class="math notranslate nohighlight">\(\lambda\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lam_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y_train</span> <span class="o">-</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">lam_val</span> <span class="o">=</span> <span class="n">lam_max</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">),</span> <span class="mi">50</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">LogisticRegression()</span></code> the regularization parameter
<span class="math notranslate nohighlight">\(C\)</span> is specified as the inverse of <span class="math notranslate nohighlight">\(\lambda\)</span>. There are several
solvers for logistic regression; here we use <code class="docutils literal notranslate"><span class="pre">liblinear</span></code> which
works well with the sparse input format.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logit</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> 
                           <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">lam_max</span><span class="p">,</span>
                           <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
                           <span class="n">warm_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The path of 50 values takes approximately 40 seconds to run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">intercepts</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lam_val</span><span class="p">:</span>
    <span class="n">logit</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">l</span>
    <span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
    <span class="n">coefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">intercepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">81</span><span class="p">],</span> <span class="n">line</span> <span class="mi">6</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lam_val</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">logit</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">l</span>
<span class="ne">----&gt; </span><span class="mi">6</span>     <span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">coefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">intercepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">intercept_</span><span class="p">)</span>

<span class="nn">File ~/work/isl/isl/.venv/lib/python3.10/site-packages/sklearn/base.py:1151,</span> in <span class="ni">_fit_context.&lt;locals&gt;.decorator.&lt;locals&gt;.wrapper</span><span class="nt">(estimator, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1144</span>     <span class="n">estimator</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1146</span> <span class="k">with</span> <span class="n">config_context</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1147</span>     <span class="n">skip_parameter_validation</span><span class="o">=</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1148</span>         <span class="n">prefer_skip_nested_validation</span> <span class="ow">or</span> <span class="n">global_skip_validation</span>
<span class="g g-Whitespace">   </span><span class="mi">1149</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1150</span> <span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1151</span>     <span class="k">return</span> <span class="n">fit_method</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File ~/work/isl/isl/.venv/lib/python3.10/site-packages/sklearn/linear_model/_logistic.py:1215,</span> in <span class="ni">LogisticRegression.fit</span><span class="nt">(self, X, y, sample_weight)</span>
<span class="g g-Whitespace">   </span><span class="mi">1205</span>     <span class="n">_dtype</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">1207</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1208</span>     <span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1209</span>     <span class="n">y</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1213</span>     <span class="n">accept_large_sparse</span><span class="o">=</span><span class="n">solver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;liblinear&quot;</span><span class="p">,</span> <span class="s2">&quot;sag&quot;</span><span class="p">,</span> <span class="s2">&quot;saga&quot;</span><span class="p">],</span>
<span class="g g-Whitespace">   </span><span class="mi">1214</span> <span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1215</span> <span class="n">check_classification_targets</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1216</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1218</span> <span class="n">multi_class</span> <span class="o">=</span> <span class="n">_check_multi_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_class</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes_</span><span class="p">))</span>

<span class="nn">File ~/work/isl/isl/.venv/lib/python3.10/site-packages/sklearn/utils/multiclass.py:215,</span> in <span class="ni">check_classification_targets</span><span class="nt">(y)</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span> <span class="n">y_type</span> <span class="o">=</span> <span class="n">type_of_target</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">input_name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span> <span class="k">if</span> <span class="n">y_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>     <span class="s2">&quot;binary&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="s2">&quot;multiclass&quot;</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>     <span class="s2">&quot;multilabel-sequences&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span> <span class="p">]:</span>
<span class="ne">--&gt; </span><span class="mi">215</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span>         <span class="sa">f</span><span class="s2">&quot;Unknown label type: </span><span class="si">{</span><span class="n">y_type</span><span class="si">}</span><span class="s2">. Maybe you are trying to fit a &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">217</span>         <span class="s2">&quot;classifier, which expects discrete classes on a &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">218</span>         <span class="s2">&quot;regression target with continuous values.&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">219</span>     <span class="p">)</span>

<span class="ne">ValueError</span>: Unknown label type: continuous. Maybe you are trying to fit a classifier, which expects discrete classes on a regression target with continuous values.
</pre></div>
</div>
</div>
</div>
<p>The coefficient and intercepts have an extraneous dimension which can be removed
by the <code class="docutils literal notranslate"><span class="pre">np.squeeze()</span></code>  function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span>
<span class="n">intercepts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">intercepts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll now make a plot to compare our neural network results with the
lasso.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="p">((</span><span class="n">X_</span><span class="p">,</span> <span class="n">Y_</span><span class="p">),</span>
     <span class="n">data_</span><span class="p">,</span>
     <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)],</span>
                    <span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="s1">&#39;Test&#39;</span><span class="p">],</span>
                    <span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">]):</span>
    <span class="n">linpred_</span> <span class="o">=</span> <span class="n">X_</span> <span class="o">*</span> <span class="n">coefs</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">intercepts</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
    <span class="n">label_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">linpred_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">accuracy_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y_</span> <span class="o">==</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">label_</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lam_val</span> <span class="o">/</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                 <span class="n">accuracy_</span><span class="p">,</span>
                 <span class="s1">&#39;.--&#39;</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                 <span class="n">markersize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="n">data_</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$-\log(\lambda)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">83</span><span class="p">],</span> <span class="n">line</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="k">for</span> <span class="p">((</span><span class="n">X_</span><span class="p">,</span> <span class="n">Y_</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>      <span class="n">data_</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>      <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">),</span>
<span class="ne">----&gt; </span><span class="mi">5</span>                     <span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">Y_valid</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                     <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)],</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                     <span class="p">[</span><span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="s1">&#39;Test&#39;</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>                     <span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">]):</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">linpred_</span> <span class="o">=</span> <span class="n">X_</span> <span class="o">*</span> <span class="n">coefs</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">intercepts</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="n">label_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">linpred_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;X_valid&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Notice the use of <code class="docutils literal notranslate"><span class="pre">%%capture</span></code>, which suppresses the displaying of the partially completed figure. This is useful
when making a complex figure, since the steps can be spread across two or more cells.
We now add a plot of the lasso accuracy, and display the composed figure by simply entering its name at the end of the cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imdb_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">imdb_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span><span class="p">)</span>
<span class="n">summary_plot</span><span class="p">(</span><span class="n">imdb_results</span><span class="p">,</span>
             <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
             <span class="n">col</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
             <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">test_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">84</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">imdb_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">imdb_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">summary_plot</span><span class="p">(</span><span class="n">imdb_results</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>              <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>              <span class="n">col</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>              <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;imdb_logger&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>From the graphs we see that the accuracy of the lasso logistic regression peaks at about <span class="math notranslate nohighlight">\(0.88\)</span>,  as it does for  the neural network.</p>
<p>Once again, we end with a cleanup.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span><span class="p">(</span><span class="n">imdb_model</span><span class="p">,</span>
    <span class="n">imdb_trainer</span><span class="p">,</span>
    <span class="n">imdb_logger</span><span class="p">,</span>
    <span class="n">imdb_dm</span><span class="p">,</span>
    <span class="n">imdb_train</span><span class="p">,</span>
    <span class="n">imdb_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">85</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">del</span><span class="p">(</span><span class="n">imdb_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">imdb_trainer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">imdb_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">imdb_dm</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">imdb_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">imdb_test</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;imdb_model&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="recurrent-neural-networks">
<h2>Recurrent Neural Networks<a class="headerlink" href="#recurrent-neural-networks" title="Permalink to this heading">#</a></h2>
<p>In this lab we fit the models illustrated in
Section 10.5.</p>
<section id="sequential-models-for-document-classification">
<h3>Sequential Models for Document Classification<a class="headerlink" href="#sequential-models-for-document-classification" title="Permalink to this heading">#</a></h3>
<p>Here we  fit a simple  LSTM RNN for sentiment prediction to
the <code class="docutils literal notranslate"><span class="pre">IMDb</span></code> movie-review data, as discussed in Section 10.5.1.
For an RNN we use the sequence of words in a document, taking their
order into account. We loaded the preprocessed
data at the beginning of
Section 10.9.5.
A script that details the preprocessing can be found in the
<code class="docutils literal notranslate"><span class="pre">ISLP</span></code> library. Notably, since more than 90% of the documents
had fewer than 500 words, we set the document length to 500. For
longer documents, we used the last 500 words, and for shorter
documents, we padded the front with blanks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imdb_seq_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">imdb_seq_train</span><span class="p">,</span>
                               <span class="n">imdb_seq_test</span><span class="p">,</span>
                               <span class="n">validation</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                               <span class="n">batch_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                               <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">)</span>
                               <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">86</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">imdb_seq_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">imdb_seq_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                                <span class="n">imdb_seq_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                                <span class="n">validation</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                                <span class="n">batch_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                                <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                                <span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleDataModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The first layer of the RNN is an embedding layer of size 32, which will be
learned during  training. This layer one-hot encodes  each document
as a matrix of dimension <span class="math notranslate nohighlight">\(500 \times 10,003\)</span>, and then maps these
<span class="math notranslate nohighlight">\(10,003\)</span> dimensions down to <span class="math notranslate nohighlight">\(32\)</span>. {The extra 3 dimensions
correspond to commonly occurring non-word entries in the reviews.}
Since each word is represented by an
integer, this is effectively achieved by the creation of an embedding
matrix of size <span class="math notranslate nohighlight">\(10,003\times 32\)</span>; each of the 500 integers in the
document are then mapped to the appropriate 32 real numbers by
indexing the appropriate rows of this matrix.</p>
<p>The second  layer is an LSTM with 32 units, and the output
layer is a single logit for the binary classification task.
In the last line of the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> method below,
we take the last 32-dimensional output of the LSTM and map it to our response.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LSTMModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                            <span class="n">hidden_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">h_n</span><span class="p">,</span> <span class="n">c_n</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">val</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p>We instantiate and take a look at the summary of the model, using the
first 10 documents in the corpus.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lstm_model</span> <span class="o">=</span> <span class="n">LSTMModel</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">summary</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">,</span>
        <span class="n">input_data</span><span class="o">=</span><span class="n">imdb_seq_train</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span>
        <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">88</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">lstm_model</span> <span class="o">=</span> <span class="n">LSTMModel</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">summary</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="n">input_data</span><span class="o">=</span><span class="n">imdb_seq_train</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                    <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                    <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;summary&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The 10,003 is suppressed in the summary, but we see it in the
parameter count, since <span class="math notranslate nohighlight">\(10,003\times 32=320,096\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lstm_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">binary_classification</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">)</span>
<span class="n">lstm_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;IMDB_LSTM&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">89</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lstm_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">binary_classification</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">lstm_logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;IMDB_LSTM&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lstm_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">max_epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                       <span class="n">logger</span><span class="o">=</span><span class="n">lstm_logger</span><span class="p">,</span>
                       <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="n">lstm_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">lstm_module</span><span class="p">,</span>
                 <span class="n">datamodule</span><span class="o">=</span><span class="n">imdb_seq_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">90</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lstm_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                        <span class="n">max_epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                        <span class="n">logger</span><span class="o">=</span><span class="n">lstm_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">lstm_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">lstm_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                  <span class="n">datamodule</span><span class="o">=</span><span class="n">imdb_seq_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;Trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The rest is now similar to other networks we have fit. We
track the test performance as the network is fit, and see that it attains 85% accuracy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lstm_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">lstm_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">imdb_seq_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">91</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lstm_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">lstm_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">imdb_seq_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;lstm_trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We once again show the learning progress, followed by cleanup.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lstm_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">lstm_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">summary_plot</span><span class="p">(</span><span class="n">lstm_results</span><span class="p">,</span>
             <span class="n">ax</span><span class="p">,</span>
             <span class="n">col</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
             <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">92</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">lstm_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">lstm_logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics_file_path</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">summary_plot</span><span class="p">(</span><span class="n">lstm_results</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>              <span class="n">ax</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>              <span class="n">col</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>              <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;lstm_logger&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">,</span>
    <span class="n">lstm_trainer</span><span class="p">,</span>
    <span class="n">lstm_logger</span><span class="p">,</span>
    <span class="n">imdb_seq_dm</span><span class="p">,</span>
    <span class="n">imdb_seq_train</span><span class="p">,</span>
    <span class="n">imdb_seq_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">93</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">del</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">,</span>
<span class="ne">----&gt; </span><span class="mi">2</span>     <span class="n">lstm_trainer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">lstm_logger</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">imdb_seq_dm</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">imdb_seq_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">imdb_seq_test</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;lstm_trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="time-series-prediction">
<h3>Time Series Prediction<a class="headerlink" href="#time-series-prediction" title="Permalink to this heading">#</a></h3>
<p>We now show how to fit the models in Section 10.5.2
for  time series prediction.
We first load and standardize the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NYSE</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;NYSE&#39;</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DJ_return&#39;</span><span class="p">,</span> <span class="s1">&#39;log_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;log_volatility&#39;</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(</span>
                     <span class="n">with_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">with_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">NYSE</span><span class="p">[</span><span class="n">cols</span><span class="p">]),</span>
                 <span class="n">columns</span><span class="o">=</span><span class="n">NYSE</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                 <span class="n">index</span><span class="o">=</span><span class="n">NYSE</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next we set up the lagged versions of the data, dropping
any rows with missing values using the <code class="docutils literal notranslate"><span class="pre">dropna()</span></code>  method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">newcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">newcol</span><span class="p">[</span><span class="n">lag</span><span class="p">:]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="n">lag</span><span class="p">]</span>
        <span class="n">X</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">lag</span><span class="p">),</span> <span class="n">newcol</span><span class="p">)</span>
<span class="n">X</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">NYSE</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we extract the response, training indicator, and drop the current day’s <code class="docutils literal notranslate"><span class="pre">DJ_return</span></code> and
<code class="docutils literal notranslate"><span class="pre">log_volatility</span></code> to predict only from previous day’s data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y</span><span class="p">,</span> <span class="n">train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;log_volume&#39;</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">)</span>
<span class="n">X</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;DJ_return_1&#39;, &#39;log_volume_1&#39;, &#39;log_volatility_1&#39;, &#39;DJ_return_2&#39;,
       &#39;log_volume_2&#39;, &#39;log_volatility_2&#39;, &#39;DJ_return_3&#39;, &#39;log_volume_3&#39;,
       &#39;log_volatility_3&#39;, &#39;DJ_return_4&#39;, &#39;log_volume_4&#39;, &#39;log_volatility_4&#39;,
       &#39;DJ_return_5&#39;, &#39;log_volume_5&#39;, &#39;log_volatility_5&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<p>We first fit a simple linear model and compute the <span class="math notranslate nohighlight">\(R^2\)</span> on the test data using
the <code class="docutils literal notranslate"><span class="pre">score()</span></code>  method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">M</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">train</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">train</span><span class="p">])</span>
<span class="n">M</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">train</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="o">~</span><span class="n">train</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.41289129385625223
</pre></div>
</div>
</div>
</div>
<p>We refit this model, including the factor variable <code class="docutils literal notranslate"><span class="pre">day_of_week</span></code>.
For a categorical series in <code class="docutils literal notranslate"><span class="pre">pandas</span></code>, we can form the indicators
using the <code class="docutils literal notranslate"><span class="pre">get_dummies()</span></code>  method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_day</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> 
                 <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">NYSE</span><span class="p">[</span><span class="s1">&#39;day_of_week&#39;</span><span class="p">]),</span>
                 <span class="n">on</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we do not have
to reinstantiate the linear regression model
as its <code class="docutils literal notranslate"><span class="pre">fit()</span></code> method accepts a design matrix and a response directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_day</span><span class="p">[</span><span class="n">train</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">train</span><span class="p">])</span>
<span class="n">M</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_day</span><span class="p">[</span><span class="o">~</span><span class="n">train</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="o">~</span><span class="n">train</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4595563133053274
</pre></div>
</div>
</div>
</div>
<p>This model achieves an <span class="math notranslate nohighlight">\(R^2\)</span> of about 46%.</p>
<p>To fit the RNN, we must reshape the data, as it will expect 5 lagged
versions of each feature as indicated by the  <code class="docutils literal notranslate"><span class="pre">input_shape</span></code> argument
to the layer <code class="docutils literal notranslate"><span class="pre">nn.RNN()</span></code>  below. We first
ensure the columns of  our data frame are such that a reshaped
matrix will have the variables correctly lagged. We use the
<code class="docutils literal notranslate"><span class="pre">reindex()</span></code>  method to do this.</p>
<p>For an input shape <code class="docutils literal notranslate"><span class="pre">(5,3)</span></code>, each row represents a lagged version of the three variables.
The <code class="docutils literal notranslate"><span class="pre">nn.RNN()</span></code> layer also expects the first row of each
observation to be earliest in time, so we must reverse the current order.  Hence we loop over
<code class="docutils literal notranslate"><span class="pre">range(5,0,-1)</span></code> below, which is
an example of using a  <code class="docutils literal notranslate"><span class="pre">slice()</span></code>  to index
iterable objects. The general notation is <code class="docutils literal notranslate"><span class="pre">start:end:step</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ordered_cols</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ordered_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">ordered_cols</span><span class="p">)</span>
<span class="n">X</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;DJ_return_5&#39;, &#39;log_volume_5&#39;, &#39;log_volatility_5&#39;, &#39;DJ_return_4&#39;,
       &#39;log_volume_4&#39;, &#39;log_volatility_4&#39;, &#39;DJ_return_3&#39;, &#39;log_volume_3&#39;,
       &#39;log_volatility_3&#39;, &#39;DJ_return_2&#39;, &#39;log_volume_2&#39;, &#39;log_volatility_2&#39;,
       &#39;DJ_return_1&#39;, &#39;log_volume_1&#39;, &#39;log_volatility_1&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<p>We now reshape the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_rnn</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">X_rnn</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(6046, 5, 3)
</pre></div>
</div>
</div>
</div>
<p>By specifying the first size as -1, <code class="docutils literal notranslate"><span class="pre">numpy.reshape()</span></code> deduces its size based on the remaining arguments.</p>
<p>Now we are ready to proceed with the RNN, which uses 12 hidden units, and  10%
dropout.
After passing through the RNN,  we extract the final time point as <code class="docutils literal notranslate"><span class="pre">val[:,-1]</span></code>
in <code class="docutils literal notranslate"><span class="pre">forward()</span></code> below. This gets passed through a 10% dropout and then flattened through
a linear layer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NYSEModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NYSEModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RNN</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
                          <span class="mi">12</span><span class="p">,</span>
                          <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">val</span><span class="p">,</span> <span class="n">h_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">val</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="n">nyse_model</span> <span class="o">=</span> <span class="n">NYSEModel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We  fit the model in a similar fashion to previous networks. We
supply the <code class="docutils literal notranslate"><span class="pre">fit</span></code> function with test data as validation data, so that when
we monitor its progress and plot the history function we can see the
progress on the test data. Of course we should not use this as a basis for
early stopping, since then the test performance would be biased.</p>
<p>We form the training dataset similar to
our <code class="docutils literal notranslate"><span class="pre">Hitters</span></code> example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train</span><span class="p">,</span> <span class="o">~</span><span class="n">train</span><span class="p">]:</span>
    <span class="n">X_rnn_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X_rnn</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">Y_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">X_rnn_t</span><span class="p">,</span> <span class="n">Y_t</span><span class="p">))</span>
<span class="n">nyse_train</span><span class="p">,</span> <span class="n">nyse_test</span> <span class="o">=</span> <span class="n">datasets</span>
</pre></div>
</div>
</div>
</div>
<p>Following our usual pattern, we inspect the summary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary</span><span class="p">(</span><span class="n">nyse_model</span><span class="p">,</span>
        <span class="n">input_data</span><span class="o">=</span><span class="n">X_rnn_t</span><span class="p">,</span>
        <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">104</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">summary</span><span class="p">(</span><span class="n">nyse_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>         <span class="n">input_data</span><span class="o">=</span><span class="n">X_rnn_t</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                    <span class="s1">&#39;output_size&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                    <span class="s1">&#39;num_params&#39;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;summary&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>\newpage
We again put the two datasets into a data module, with a
batch size of 64.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nyse_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">nyse_train</span><span class="p">,</span>
                           <span class="n">nyse_test</span><span class="p">,</span>
                           <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">),</span>
                           <span class="n">validation</span><span class="o">=</span><span class="n">nyse_test</span><span class="p">,</span>
                           <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">105</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">nyse_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">nyse_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                            <span class="n">nyse_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                            <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                            <span class="n">validation</span><span class="o">=</span><span class="n">nyse_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleDataModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We run some data through our model to be sure the sizes match up correctly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nyse_dm</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">nyse_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">out</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">106</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nyse_dm</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">out</span> <span class="o">=</span> <span class="n">nyse_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">out</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

<span class="ne">NameError</span>: name &#39;nyse_dm&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We follow our previous example for setting up a trainer for a
regression problem, requesting the <span class="math notranslate nohighlight">\(R^2\)</span> metric
to be be computed at each epoch.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nyse_optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">nyse_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                         <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">nyse_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="n">nyse_model</span><span class="p">,</span>
                                      <span class="n">optimizer</span><span class="o">=</span><span class="n">nyse_optimizer</span><span class="p">,</span>
                                      <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;r2&#39;</span><span class="p">:</span><span class="n">R2Score</span><span class="p">()})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">107</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">nyse_optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">nyse_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                          <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">nyse_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="n">nyse_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                                       <span class="n">optimizer</span><span class="o">=</span><span class="n">nyse_optimizer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                                       <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;r2&#39;</span><span class="p">:</span><span class="n">R2Score</span><span class="p">()})</span>

<span class="ne">NameError</span>: name &#39;SimpleModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Fitting the model should by now be familiar.
The results on the test data are very similar to the linear AR model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nyse_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">max_epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                       <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="n">nyse_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">nyse_module</span><span class="p">,</span>
                 <span class="n">datamodule</span><span class="o">=</span><span class="n">nyse_dm</span><span class="p">)</span>
<span class="n">nyse_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">nyse_module</span><span class="p">,</span>
                  <span class="n">datamodule</span><span class="o">=</span><span class="n">nyse_dm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">108</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">nyse_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                        <span class="n">max_epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">nyse_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">nyse_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                  <span class="n">datamodule</span><span class="o">=</span><span class="n">nyse_dm</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">nyse_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">nyse_module</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                   <span class="n">datamodule</span><span class="o">=</span><span class="n">nyse_dm</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;Trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We could also fit a model without the <code class="docutils literal notranslate"><span class="pre">nn.RNN()</span></code> layer by just
using a <code class="docutils literal notranslate"><span class="pre">nn.Flatten()</span></code> layer instead. This would be a nonlinear AR model. If in addition we excluded the
hidden layer, this would be equivalent to our earlier linear AR model.</p>
<p>Instead we will fit a nonlinear AR model using the feature set <code class="docutils literal notranslate"><span class="pre">X_day</span></code> that includes the <code class="docutils literal notranslate"><span class="pre">day_of_week</span></code> indicators.
To do so, we
must first create our test and training datasets and a corresponding
data module. This may seem a little burdensome, but is part of the
general pipeline for <code class="docutils literal notranslate"><span class="pre">torch</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train</span><span class="p">,</span> <span class="o">~</span><span class="n">train</span><span class="p">]:</span>
    <span class="n">X_day_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X_day</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">Y_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">X_day_t</span><span class="p">,</span> <span class="n">Y_t</span><span class="p">))</span>
<span class="n">day_train</span><span class="p">,</span> <span class="n">day_test</span> <span class="o">=</span> <span class="n">datasets</span>
</pre></div>
</div>
</div>
</div>
<p>Creating a data module follows a familiar pattern.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">day_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">day_train</span><span class="p">,</span>
                          <span class="n">day_test</span><span class="p">,</span>
                          <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">),</span>
                          <span class="n">validation</span><span class="o">=</span><span class="n">day_test</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">110</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">day_dm</span> <span class="o">=</span> <span class="n">SimpleDataModule</span><span class="p">(</span><span class="n">day_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                           <span class="n">day_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">num_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_num_workers</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                           <span class="n">validation</span><span class="o">=</span><span class="n">day_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                           <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;SimpleDataModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We build a <code class="docutils literal notranslate"><span class="pre">NonLinearARModel()</span></code> that takes as input the 20 features and a hidden layer  with 32 units. The remaining steps are familiar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NonLinearARModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NonLinearARModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
                                      <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
                                      <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
                                      <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
                                      <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nl_model</span> <span class="o">=</span> <span class="n">NonLinearARModel</span><span class="p">()</span>
<span class="n">nl_optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">nl_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                           <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">nl_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="n">nl_model</span><span class="p">,</span>
                                        <span class="n">optimizer</span><span class="o">=</span><span class="n">nl_optimizer</span><span class="p">,</span>
                                        <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;r2&#39;</span><span class="p">:</span><span class="n">R2Score</span><span class="p">()})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">112</span><span class="p">],</span> <span class="n">line</span> <span class="mi">4</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">nl_model</span> <span class="o">=</span> <span class="n">NonLinearARModel</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">nl_optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">nl_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                            <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">nl_module</span> <span class="o">=</span> <span class="n">SimpleModule</span><span class="o">.</span><span class="n">regression</span><span class="p">(</span><span class="n">nl_model</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                                         <span class="n">optimizer</span><span class="o">=</span><span class="n">nl_optimizer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                                         <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;r2&#39;</span><span class="p">:</span><span class="n">R2Score</span><span class="p">()})</span>

<span class="ne">NameError</span>: name &#39;SimpleModule&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We continue with the usual training steps, fit the model,
and evaluate the test error. We see the test <span class="math notranslate nohighlight">\(R^2\)</span> is a slight improvement over the linear AR model that also includes <code class="docutils literal notranslate"><span class="pre">day_of_week</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nl_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">max_epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                         <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="n">nl_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">nl_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">day_dm</span><span class="p">)</span>
<span class="n">nl_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">nl_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">day_dm</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">113</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">nl_trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                          <span class="n">max_epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                          <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ErrorTracker</span><span class="p">()])</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">nl_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">nl_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">day_dm</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">nl_trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">nl_module</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">day_dm</span><span class="p">)</span> 

<span class="ne">NameError</span>: name &#39;Trainer&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs/chapters/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Introduction to Statistical Learning</p>
      </div>
    </a>
    <a class="right-next"
       href="Ch11-surv-lab.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 11</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Chapter 10</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#lab-deep-learning">Lab: Deep Learning</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#torch-specific-imports">Torch-Specific Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#single-layer-network-on-hitters-data">Single Layer Network on Hitters Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-models">Linear Models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specifying-a-network-classes-and-inheritance">Specifying a Network: Classes and Inheritance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleanup">Cleanup</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multilayer-network-on-the-mnist-digit-data">Multilayer Network on the MNIST Digit Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convolutional-neural-networks">Convolutional Neural Networks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-acceleration">Hardware Acceleration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-pretrained-cnn-models">Using Pretrained CNN Models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imdb-document-classification">IMDB Document Classification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-to-lasso">Comparison to Lasso</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recurrent-neural-networks">Recurrent Neural Networks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-models-for-document-classification">Sequential Models for Document Classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-prediction">Time Series Prediction</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Trevor Hastie et al.
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>